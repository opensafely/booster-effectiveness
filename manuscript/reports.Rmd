---
title: "Effectiveness of BNT162b2 booster doses in England: a observational study in OpenSAFELY-TPP: Materials"
output:
  html_document:
    keep_md: yes
    self_contained: yes
  word_document: default
  bookdown::html_document2:
    number_sections: no
    toc: no
  pdf_document:
    toc: no
bibliography: references.bib
csl: vancouver.csl
link-citations: yes
zotero: yes
header-includes:
- \usepackage{float} 
- \floatplacement{figure}{H}
- \usepackage{caption}
- \captionsetup[figure]{labelformat=empty}
- \captionsetup[table]{labelformat=empty}
---

```{r setup, include=FALSE}

library('tidyverse')
library('here')
library('glue')
library('lubridate')
library('gt')
library('patchwork')
library('scales')
source(here("lib", "functions", "utility.R"))

# where are the outputs (ie the inputs for this manuscript!) saved?
#output_dir_os <- here("output", "manuscript-objects")
output_dir_os <- here("released_output", "manuscript-objects")

# where should we put the objects created within this rmd script?
output_dir_rmd <- here("manuscript", "figures")
fs::dir_create(output_dir_rmd)

# only applicable if `self-contained: yes` option is enables in yaml header
knitr::opts_chunk$set(
  echo = TRUE,
  fig.path = paste0(output_dir_rmd, "/"),
  fig.pos = 'H' #to stop figures floating around when rendering to pdf
)

study_dates <-
  jsonlite::read_json(path=here("lib", "design", "study-dates.json")) %>%
  map(as.Date)

postbaselinecuts <- read_rds(here("lib", "design", "postbaselinecuts.rds"))

cohortsummary <- read_csv(fs::path(output_dir_os, "cohortsummary.csv"))
matchsummary <- read_csv(fs::path(output_dir_os, "matchsummary.csv"))
matchsummary_treated <- read_csv(fs::path(output_dir_os, "matchsummary_treated.csv")) %>% filter(treated == 1L)
matchsummary_control <- read_csv(fs::path(output_dir_os, "matchsummary_treated.csv")) %>% filter(treated == 0L)
matchflowchart <- read_csv(fs::path(output_dir_os, "matchflowchart.csv"))
matchcoverage <- read_csv(fs::path(output_dir_os, "matchcoverage.csv"))
incidences <- read_csv(fs::path(output_dir_os, "none", "incidence_all.csv")) %>% mutate(events=events_1+events_0)



studydurationweeks <- as.numeric(as.duration(study_dates$studyend_date - study_dates$studystart_date +1) , "weeks")
```

```{r, effects, echo=FALSE, message=FALSE, warning=FALSE}

  specify_decimal <- function(x, k, trim=FALSE) {
  
    fmtd <- format(round(x, k), nsmall = k)
    if (trim) {fmtd <- trimws(fmtd)}
    return(fmtd)
  }
  #
  # print_est1bracket <- function(x, b, round=1){
  #   paste0(specify_decimal(x, round), " (", specify_decimal(b, round), ")")
  # }
  #
  print_est2bracket <- function(x, b1, b2, round=1){
    paste0(specify_decimal(x, round), " (", specify_decimal(b1, round), ", ", specify_decimal(b2, round), ")")
  }

  outcomes <- 
    c(
      "postest",
      #"covidemergency",
      "covidadmitted",
      #"covidcc",
      "coviddeath",
      "noncoviddeath"
    ) %>% 
    set_names(., .)


km <- 
  bind_rows(
    read_csv(fs::path(output_dir_os, "none", "km.csv")),
    read_csv(fs::path(output_dir_os, "vax12_type", "km.csv")),
    read_csv(fs::path(output_dir_os, "cev", "km.csv")) %>% mutate(subgroup_level=as.character(subgroup_level)),
    read_csv(fs::path(output_dir_os, "age65plus", "km.csv")) %>% mutate(subgroup_level=as.character(subgroup_level))
  ) %>%
  filter(
    outcome %in% outcomes
  ) %>%
  mutate(
    subgroup_descr = fct_inorder(subgroup_descr),
    subgroup_level = fct_inorder(subgroup_level),
    subgroup_level_descr = fct_inorder(fct_explicit_na(subgroup_level_descr, "All")),
    treatment_descr = fct_inorder(treatment_descr),
    outcome_descr = fct_inorder(outcome_descr),
    outcome_descr_wrap = fct_relabel(outcome_descr, ~str_wrap(., width=12)),
    #model_name = fct_inorder(str_wrap(model_name, 15)),
  )
# 
# cmlinc <- read_csv(fs::path(output_dir_os, "cmlinc.csv")) %>%
#   mutate(
#     treatment_descr = fct_inorder(treatment_descr),
#     outcome_descr = fct_inorder(outcome_descr),
#     model_name = fct_inorder(str_wrap(model_name, 15)),
#     inc_CI_to = paste0(label_number(0.1, scale=1000)(1-survival.ul), " to ", label_number(0.1, scale=1000)(1-survival.ll))
#   )

# riskdiff <- read_csv(fs::path(output_dir_os, "riskdiff.csv")) %>%
#   mutate(
#     treatment_descr = fct_inorder(treatment_descr),
#     outcome_descr = fct_inorder(outcome_descr),
#     model_name = fct_inorder(str_wrap(model_name, 15)),
#     diff_CI_to = paste0(label_number(0.01, scale=1000)(diff.ll), " to ", label_number(0.01, scale=1000)(diff.ul))
#   )


hazards <- 
  bind_rows(
    read_csv(fs::path(output_dir_os, "none", "effects.csv")),
    read_csv(fs::path(output_dir_os, "vax12_type", "effects.csv")),
    read_csv(fs::path(output_dir_os, "cev", "effects.csv")) %>% mutate(subgroup_level=as.character(subgroup_level)),
    read_csv(fs::path(output_dir_os, "age65plus", "effects.csv"))  %>% mutate(subgroup_level=as.character(subgroup_level)),
  ) %>%
  filter(
    outcome %in% outcomes
  ) %>%
  mutate(
    
    subgroup_descr = fct_inorder(subgroup_descr),
    subgroup_level = fct_inorder(subgroup_level),
    subgroup_level_descr = fct_inorder(fct_explicit_na(subgroup_level_descr, "All")),
    treatment_descr = fct_inorder(treatment_descr),
    outcome_descr = fct_inorder(outcome_descr),
    outcome_descr_wrap = fct_relabel(outcome_descr, ~str_wrap(., width=15)),
    #model_name = fct_inorder(str_wrap(model_name, 15)),
    hr_display = paste0(label_number(accuracy=0.01)(hr), " (", label_number(accuracy=0.01)(hr.ll), "-", label_number(accuracy=0.01)(hr.ul), ")"),
    ve_display = paste0(label_percent(accuracy=0.1)(ve), " (", label_percent(accuracy=0.1, suffix="")(ve.ll), "-", label_percent(accuracy=0.1, suffix="")(ve.ul), ")"),
    
  )

overallhazards <- 
  bind_rows(
    read_csv(fs::path(output_dir_os, "none", "overalleffects.csv")),
    read_csv(fs::path(output_dir_os, "vax12_type", "overalleffects.csv")),
    read_csv(fs::path(output_dir_os, "cev", "overalleffects.csv")) %>% mutate(subgroup_level=as.character(subgroup_level)),
    read_csv(fs::path(output_dir_os, "age65plus", "overalleffects.csv")) %>% mutate(subgroup_level=as.character(subgroup_level)),
  ) %>%
  filter(
    outcome %in% outcomes
  ) %>%
  mutate(
    
    subgroup_descr = fct_inorder(subgroup_descr),
    subgroup_level = fct_inorder(subgroup_level),
    subgroup_level_descr = fct_inorder(fct_explicit_na(subgroup_level_descr, "All")),
    treatment_descr = fct_inorder(treatment_descr),
    outcome_descr = fct_inorder(outcome_descr),
    outcome_descr_wrap = fct_relabel(outcome_descr, ~str_wrap(., width=15)),
    #model_name = fct_inorder(str_wrap(model_name, 15)),
    hr_display = paste0(label_number(accuracy=0.01)(hr), " (", label_number(accuracy=0.01)(hr.ll), "-", label_number(accuracy=0.01)(hr.ul), ")"),
    ve_display = paste0(label_percent(accuracy=0.1)(ve), " (", label_percent(accuracy=0.1, suffix="")(ve.ll), "-", label_percent(accuracy=0.1, suffix="")(ve.ul), ")"),
  )


meta28hazards <- 
  # derive directly from hazards as meta28effects table needs to be re-run
  bind_rows(
    read_csv(fs::path(output_dir_os, "none", "effects.csv")),
    read_csv(fs::path(output_dir_os, "vax12_type", "effects.csv")),
    read_csv(fs::path(output_dir_os, "cev", "effects.csv")) %>% mutate(subgroup_level=as.character(subgroup_level)),
    read_csv(fs::path(output_dir_os, "age65plus", "effects.csv"))  %>% mutate(subgroup_level=as.character(subgroup_level)),
  ) %>%
  filter(
    outcome %in% outcomes
  ) %>%
  mutate(
    period = (term_right>28) + 1,
    subgroup_descr = fct_inorder(subgroup_descr),
    subgroup_level = fct_inorder(subgroup_level),
    subgroup_level_descr = fct_inorder(fct_explicit_na(subgroup_level_descr, "All")),
    treatment_descr = fct_inorder(treatment_descr),
    outcome_descr = fct_inorder(outcome_descr),
    outcome_descr_wrap = fct_relabel(outcome_descr, ~str_wrap(., width=15)),
  ) %>%
  group_by(
    treatment, treatment_descr, outcome, outcome_descr, outcome_descr_wrap, subgroup, subgroup_variable, subgroup_descr, subgroup_level, subgroup_level_descr, model, model_descr, period, 
  ) %>%
  summarise(
    term_left = min(term_left),
    term_right = max(term_right),
    term_midpoint = (term_left+term_right)/2,
    estimate = weighted.mean(estimate, robust.se^-2),
    std.error = sqrt(1/sum(std.error^-2)),
    robust.se = sqrt(1/sum(robust.se^-2)),
    statistic = estimate/robust.se,
    p.value = 2 * pmin(pnorm(statistic), pnorm(-statistic)),
    conf.low = estimate + qnorm(0.025)*robust.se,
    conf.high = estimate + qnorm(0.975)*robust.se,
    hr = exp(estimate),
    hr.ll = exp(conf.low),
    hr.ul = exp(conf.high),
    ve = 1-hr,
    ve.ll = 1-hr.ul,
    ve.ul = 1-hr.ll
  ) %>%
  ungroup() %>%
  mutate(
    hr_display = paste0(label_number(accuracy=0.01)(hr), " (", label_number(accuracy=0.01)(hr.ll), "-", label_number(accuracy=0.01)(hr.ul), ")"),
    ve_display = paste0(label_percent(accuracy=0.1)(ve), " (", label_percent(accuracy=0.1, suffix="")(ve.ll), "-", label_percent(accuracy=0.1, suffix="")(ve.ul), ")"),
  )



meta42hazards <- 
  # derive directly from hazards as meta28effects table needs to be re-run
  bind_rows(
    read_csv(fs::path(output_dir_os, "none", "effects.csv")),
    read_csv(fs::path(output_dir_os, "vax12_type", "effects.csv")),
    read_csv(fs::path(output_dir_os, "cev", "effects.csv")) %>% mutate(subgroup_level=as.character(subgroup_level)),
    read_csv(fs::path(output_dir_os, "age65plus", "effects.csv"))  %>% mutate(subgroup_level=as.character(subgroup_level)),
  ) %>%
  filter(
    outcome %in% outcomes
  ) %>%
  mutate(
    period = (term_right>42) + 1,
    subgroup_descr = fct_inorder(subgroup_descr),
    subgroup_level = fct_inorder(subgroup_level),
    subgroup_level_descr = fct_inorder(fct_explicit_na(subgroup_level_descr, "All")),
    treatment_descr = fct_inorder(treatment_descr),
    outcome_descr = fct_inorder(outcome_descr),
    outcome_descr_wrap = fct_relabel(outcome_descr, ~str_wrap(., width=15)),
  ) %>%
  group_by(
    treatment, treatment_descr, outcome, outcome_descr, outcome_descr_wrap, subgroup, subgroup_variable, subgroup_descr, subgroup_level, subgroup_level_descr, model, model_descr, period, 
  ) %>%
  summarise(
    term_left = min(term_left),
    term_right = max(term_right),
    term_midpoint = (term_left+term_right)/2,
    estimate = weighted.mean(estimate, robust.se^-2),
    std.error = sqrt(1/sum(std.error^-2)),
    robust.se = sqrt(1/sum(robust.se^-2)),
    statistic = estimate/robust.se,
    p.value = 2 * pmin(pnorm(statistic), pnorm(-statistic)),
    conf.low = estimate + qnorm(0.025)*robust.se,
    conf.high = estimate + qnorm(0.975)*robust.se,
    hr = exp(estimate),
    hr.ll = exp(conf.low),
    hr.ul = exp(conf.high),
    ve = 1-hr,
    ve.ll = 1-hr.ul,
    ve.ul = 1-hr.ll
  ) %>%
  ungroup() %>%
  mutate(
    hr_display = paste0(label_number(accuracy=0.01)(hr), " (", label_number(accuracy=0.01)(hr.ll), "-", label_number(accuracy=0.01)(hr.ul), ")"),
    ve_display = paste0(label_percent(accuracy=0.1)(ve), " (", label_percent(accuracy=0.1, suffix="")(ve.ll), "-", label_percent(accuracy=0.1, suffix="")(ve.ul), ")"),
  )


hazards3 <- hazards %>% filter(model==3)

```

\newpage

<!-- TODO -->

<!-- * full description of booster eligiblity over time -->

<!-- * figure 1 chart with SMD / %-point differences -->

<!-- * check for moderna references and remove if necessary -->

<!-- * check final recruitment day and include in results -->

<!-- * check if rolling average restrictions are ever used (need to output dataset) -->

<!-- * references -->



#### Table 0: Inclusion criteria

```{r flowchart, echo=FALSE, warning=FALSE, message=FALSE}

matchflowchart %>%
  transmute(
    treatment,
    stage,
    criteria = str_wrap(criteria, 40),
    n,
    n_exclude,
    pct_all
  ) %>%
  pivot_wider(
    id_cols = c(stage, criteria),
    names_from = treatment,
    values_from = c(n, n_exclude, pct_all)
  ) %>%
  gt() %>%
  cols_label(
    stage="",
    criteria = "",
    
    n_pfizer = "N",
    #n_moderna = "N",

    n_exclude_pfizer = "N excluded",
    #n_exclude_moderna = "N excluded",
    
    pct_all_pfizer = "% remaining",
    #pct_all_moderna = "% remaining",
  ) %>%
  tab_spanner(
    label = "BNT162b2",
    columns = ends_with("pfizer")
  ) %>%
  # tab_spanner(
  #   label = "mRNA-1273",
  #   columns = ends_with("moderna")
  # ) %>%
  fmt_percent(
    columns = starts_with(c("pct_")),
    decimals = 1
  ) %>%
  fmt_number(
    columns = starts_with(c("n_")),
    decimals= 0
  ) %>%
  fmt_missing(
    everything(),
    missing_text="-"
  ) %>%
  tab_style(
    style=cell_text(whitespace ="pre-wrap"),
    #style=cell_text(style ="italic"),
    locations = cells_body(columns = "criteria")
  )
```


#### Table 1: Participant characteristics

Participant characteristics as on the day of recruitment into the treatment or control group.

```{r table1, echo=FALSE, warning=FALSE, message=FALSE}
table1_body <- read_csv(fs::path(output_dir_os, "matchtable1.csv")) %>% filter(treatment=="pfizer")
table1_by <- read_csv(fs::path(output_dir_os, "matchtable1by.csv")) %>% filter(treatment=="pfizer")

table1 <- 
  table1_body %>%
  #filter(outcome %in% outcomes) %>%
  group_by(variable) %>%
  mutate(
    label = if_else(row_number()==1, label, str_c("&nbsp;&nbsp;&nbsp;", label)),
  ) %>%
  mutate(
    across(
      starts_with("stat_"),
      ~if_else(is.na(.x) & row_number()==1, "", .x)
    )
  ) %>%
  ungroup() %>%
  mutate(
    order = cumsum(lag(variable, 1, first(variable))!=variable)
  ) %>%
  select(
    variable, var_label, label, starts_with("stat_"), order
  ) %>%
  rename(!!!set_names(table1_by$by_col, table1_by$by_chr))


table1 %>%
  gt(groupname_col="treatment_descr") %>%
  fmt_markdown(columns = "label") %>%
  tab_style(
    style = list(
      cell_fill(color = "gray96")
    ),
    locations = cells_body(
      rows = order%%2 == 0
    )
  ) %>%
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = cells_column_labels(everything())
  ) %>%
  cols_label(
     label=md("Characteristic")
  ) %>%
  cols_hide(c("variable", "var_label", "order"))
```


\newpage


#### Table 2: Follow-up and outcomes

Total follow-up and incidence rates for each outcome, by treatment group. The cumulative incidence of each outcome is provided in Supplementary Figure S2.

```{r table2, echo=FALSE, warning=FALSE, message=FALSE}
incidences %>%
  filter(
    fup_period == "All",
    outcome %in% c("postest", "covidadmitted", "coviddeath"),
    treatment == "pfizer"
  ) %>%
  left_join(
    matchsummary %>% select(treatment, n_eligible, prop_matched_eligible),
    by=c("treatment")
  ) %>%
  mutate(
    treatment_descr = paste0(
      #treatment_descr, " - ",
      label_number(1, big.mark=",")(n_eligible), " eligible, ",
      label_number(1, big.mark=",")(n_1), " matched (",
      label_percent(0.1)(prop_matched_eligible), ")."
    ),
  ) %>%
  select(
    treatment_descr, 
    outcome_descr,
    q_1,
    rate_1,
    q_0, 
    rate_0,
    rrECI
  ) %>%
  mutate(
    rate_1=if_else(rate_1<0.001, "<0.001", label_number(0.001)(rate_1)),
    rate_0=if_else(rate_0<0.001, "<0.001", label_number(0.001)(rate_0)),
  ) %>%
  gt(
   groupname_col = c("treatment_descr"),
  ) %>%
  cols_label(
    #treatment_descr = "Treatment",
    outcome_descr = "Outcome",

    q_0 = "Events / person-years",
    q_1   = "Events / person-years",

    rate_0 = "Incidence rate",
    rate_1 = "Incidence rate",
    rrECI = "Incidence rate ratio (95% CI)"
  ) %>%
  tab_spanner(
    label = "Boosted",
    columns = ends_with("1")
  ) %>%
  tab_spanner(
    label = "Unboosted",
    columns = ends_with("0")
  ) %>%
  fmt_missing(
    everything(),
    missing_text="--"
  ) %>%
  cols_align(
    align = "right",
    columns = everything()
  ) 


```
\newpage


## Table 3a: Estimated booster effectiveness (5 period)

Main and subgroup analyses
```{r table_effects, echo=FALSE, message=FALSE, warning=FALSE, out.extra='', fig.height=7.5, out.width='90%', results='asis'}

hazards %>%
  filter(model==3, treatment=="pfizer") %>%
  mutate(
    period = paste(term_left+1, "-", term_right),
    ve_display = str_remove(ve_display, fixed("%"))
  ) %>%
  arrange(treatment_descr, outcome_descr, subgroup_level_descr, term_left) %>%
  group_by(outcome, treatment, subgroup_level_descr, model) %>%
  mutate(
    subgroup_level_descr=if_else(row_number()==1, subgroup_level_descr, factor(NA, levels=levels(subgroup_level_descr)))
  ) %>%
  ungroup() %>%
  select(outcome_descr, subgroup_level_descr, period, hr_display, ve_display) %>%
  gt(
    groupname_col = c("outcome_descr"),
  ) %>%
  cols_label(
    #treatment_descr = "Treatment",
    subgroup_level_descr="",
    outcome_descr = "Outcome",

    period = "Days since booster",
    hr_display   = "HR (95% CI)",
    ve_display   = "VE (95% CI)",
  ) %>%
  cols_align(
    align = "right",
    columns = everything()
  ) %>%
  fmt_missing(
    c("subgroup_level_descr"),
    missing_text=""
  )

```

\newpage

## Table 3b: Estimated booster effectiveness (2 period split at 28 days)

```{r table_effects28, echo=FALSE, message=FALSE, warning=FALSE, out.extra='', fig.height=7.5, out.width='90%', results='asis'}

meta28hazards %>%
  filter(model==3, treatment=="pfizer") %>%
  mutate(
    period = paste(term_left+1, "-", term_right),
    ve_display = str_remove(ve_display, fixed("%"))
  ) %>%
  arrange(treatment_descr, outcome_descr, subgroup_level_descr, term_left) %>%
  group_by(outcome, treatment, subgroup_level_descr, model) %>%
  mutate(
    subgroup_level_descr=if_else(row_number()==1, subgroup_level_descr, factor(NA, levels=levels(subgroup_level_descr)))
  ) %>%
  ungroup() %>%
  select(outcome_descr, subgroup_level_descr, period, hr_display, ve_display) %>%
  gt(
    groupname_col = c("outcome_descr"),
  ) %>%
  cols_label(
    #treatment_descr = "Treatment",
    subgroup_level_descr="",
    outcome_descr = "Outcome",

    period = "Days since booster",
    hr_display   = "HR (95% CI)",
    ve_display   = "VE (95% CI)",
  ) %>%
  cols_align(
    align = "right",
    columns = everything()
  ) %>%
  fmt_missing(
    c("subgroup_level_descr"),
    missing_text=""
  )

```

\newpage


## Table 3c: Estimated booster effectiveness (2 period split at 42 days)

```{r table_effects42, echo=FALSE, message=FALSE, warning=FALSE, out.extra='', fig.height=7.5, out.width='90%', results='asis'}

meta28hazards %>%
  filter(model==3, treatment=="pfizer") %>%
  mutate(
    period = paste(term_left+1, "-", term_right),
    ve_display = str_remove(ve_display, fixed("%"))
  ) %>%
  arrange(treatment_descr, outcome_descr, subgroup_level_descr, term_left) %>%
  group_by(outcome, treatment, subgroup_level_descr, model) %>%
  mutate(
    subgroup_level_descr=if_else(row_number()==1, subgroup_level_descr, factor(NA, levels=levels(subgroup_level_descr)))
  ) %>%
  ungroup() %>%
  select(outcome_descr, subgroup_level_descr, period, hr_display, ve_display) %>%
  gt(
    groupname_col = c("outcome_descr"),
  ) %>%
  cols_label(
    #treatment_descr = "Treatment",
    subgroup_level_descr="",
    outcome_descr = "Outcome",

    period = "Days since booster",
    hr_display   = "HR (95% CI)",
    ve_display   = "VE (95% CI)",
  ) %>%
  cols_align(
    align = "right",
    columns = everything()
  ) %>%
  fmt_missing(
    c("subgroup_level_descr"),
    missing_text=""
  )

```

\newpage

#### Figure 1: Booster vaccination uptake, treatment group eligibility and matching success

Cumulative booster vaccination over the duration of the study period, by matching eligibility and matching success. Separately by primary vaccination course.

```{r, vaxdate, echo=FALSE, message=FALSE, warning=FALSE, out.width='60%', out.height='50%', results='asis', out.extra=''}
#read_rds(fs::path(output_dir_os, "descriptive", "vaxdate", "plot_vaxdate_stack.rds"))

xmin <- min(matchcoverage$vax3_date )
xmax <- max(matchcoverage$vax3_date )+1
data_coverage <- matchcoverage  %>%
  mutate(
    status = factor(status, levels=c("ineligible", "unmatched", "matched")),
    status_descr = fct_relabel(status, str_to_title)
  ) %>%
  arrange(status) %>%
  mutate(
    status_descr = fct_inorder(status_descr)
  ) %>%
  filter(treatment=="pfizer") %>%
  mutate(
    # vax12_type = fct_case_when(
    #   vax12_type == "pfizer-pfizer" ~ "BNT162b2",
    #   vax12_type == "az-az" ~ "ChAdOx1-S",
    #   vax12_type == "moderna-moderna" ~ "mRNA-1273",
    #   TRUE ~ NA_character_
    # ),
    course = fct_case_when(
      vax12_type=="pfizer-pfizer" & treatment=="pfizer" ~ "2× BNT162b2  / 1× BNT162b2",
      vax12_type=="az-az" & treatment=="pfizer" ~ "2× ChAdOx1-S / 1× BNT162b2",
      vax12_type=="pfizer-pfizer" & treatment=="moderna" ~ "2× BNT162b2 / 1× mRNA-1273",
      vax12_type=="az-az" & treatment=="moderna" ~ "2× ChAdOx1-S / 1× mRNA-1273",
      TRUE ~ NA_character_
    )
  )

data_annotate <- 
  data_coverage %>%
  filter(vax12_type=="pfizer-pfizer") %>%
  group_by(status_descr, course) %>%
  summarise(
    xpos = first(lubridate::floor_date((vax3_date), "1 month")),
    ypos= max(cumuln)
  ) %>%
  ungroup() %>%
  arrange(desc(status_descr)) %>%
  mutate(
    ypos=(cumsum(ypos) + lag(cumsum(ypos), 1, 0))/2
  ) %>%
  mutate(
    course="2× ChAdOx1-S / 1× BNT162b2"
  )
  
  
ggplot(data_coverage) +
  geom_col(
    aes(
      x=vax3_date+0.5,
      y=cumuln,
      group=status_descr,
      fill=status_descr,
      colour=NULL
    ),
    position=position_stack(),
    alpha=0.5,
    width=1
  )+
  geom_rect(xmin=xmin, xmax= xmax+1, ymin=0, ymax=6, fill="grey", colour="transparent")+
  geom_text(data=data_annotate, mapping=aes(x = xpos, y = (ypos), label = status_descr, colour=status_descr), hjust=0, show.legend = FALSE)+
  facet_wrap(vars(course))+
  scale_x_date(
    breaks = unique(lubridate::ceiling_date(matchcoverage$vax3_date, "1 month")),
    limits = c(lubridate::floor_date((xmin), "1 month"), NA),
    labels = scales::label_date("%d/%m"),
    expand = expansion(add=1),
  )+
  scale_y_continuous(
    labels = scales::label_number(accuracy = 1, big.mark=","),
    expand = expansion(c(0, NA))
  )+
  scale_fill_brewer(type="qual", palette="Set2", direction = -1)+
  scale_colour_brewer(type="qual", palette="Set2", direction = -1)+
  labs(
    x="Date",
    y="Cumulative booster vaccines",
    colour=NULL,
    fill=NULL,
    alpha=NULL
  ) +
  theme_minimal()+
  theme(
    axis.line.x.bottom = element_line(),
    axis.text.x.top=element_text(hjust=0),
    strip.text.y.right = element_text(angle = 0),
    axis.ticks.x=element_line(),
    legend.position = "none"
  )+
  NULL
cat("  \n\n")
```

\newpage

#### Figure 2a: Estimated booster effectiveness (5 period)

For each outcome based on the fully adjusted model, the period-specific hazard ratios for boosting with BNT162b2 versus not boosting is shown, stratified by primary course. 

```{r plot_effects, echo=FALSE, message=FALSE, warning=FALSE, out.extra='', fig.height=7.5, out.width='90%', results='asis'}

formatpercent100 <- function(x,accuracy){
  formatx <- scales::label_percent(accuracy, suffix="")(x)

  if_else(
    formatx==scales::label_percent(accuracy, suffix="")(1),
    paste0(">",scales::label_percent(1, suffix="")((100-accuracy)/100)),
    formatx
  )
}


  ## hazard ratio

  y_breaks <- c(0.01, 0.02, 0.05, 0.1, 0.2, 0.5, 1, 2)

  
  overallhazards_plotdata <- 
    overallhazards %>%
    filter(
      model==3, 
      outcome %in% outcomes,
      treatment %in% c("pfizer"),
      subgroup_variable %in% c("none", "vax12_type")
    )
  
  
  plot_hazards <-
    hazards %>%
    filter(
      model==3,
      outcome %in% outcomes,
      treatment %in% c("pfizer"),
      subgroup_variable %in% c("none", "vax12_type")
    ) %>%
    ggplot()+
    geom_point(aes(y=hr, x=term_midpoint, colour=model_descr), position = position_dodge(width = 1.8))+
    geom_linerange(aes(ymin=hr.ll, ymax=hr.ul, x=term_midpoint, colour=model_descr), position = position_dodge(width = 1.8))+
    geom_point(data = overallhazards_plotdata, mapping = aes(y=hr, x=max(postbaselinecuts+14)), colour="darkgrey") +
    geom_linerange(data = overallhazards_plotdata, mapping = aes(ymin=hr.ll, ymax=hr.ul, x=max(postbaselinecuts+14)), colour="darkgrey") +
    geom_rect(data = overallhazards_plotdata, ymin=-Inf, ymax=Inf, xmin=max(postbaselinecuts+14)-7, xmax=max(postbaselinecuts+14)+7, fill="grey95", alpha=0.5, colour="transparent") +
    geom_hline(aes(yintercept=1), colour='grey')+
    facet_grid(rows=vars(outcome_descr_wrap), cols=vars(subgroup_level_descr), switch="y")+
    scale_y_log10(
      breaks=y_breaks,
      limits = c(0.01, 1.5),
      oob = scales::oob_keep,
      sec.axis = sec_axis(
        ~(1-.),
        name="Effectiveness (%)",
        breaks = 1-(y_breaks),
        labels = function(x){formatpercent100(x, 1)}
      )
    )+
    scale_x_continuous(breaks=c(postbaselinecuts, max(postbaselinecuts+14)), labels=c(postbaselinecuts, "Overall"), limits=c(min(postbaselinecuts), max(postbaselinecuts+14)+14), expand = c(0, 0))+
    scale_colour_brewer(type="qual", palette="Set2", guide=guide_legend(ncol=1))+
    labs(
      y="Hazard ratio",
      x="Days since booster dose",
      colour=NULL
     ) +
    theme_minimal()+
    theme(
      panel.border = element_blank(),
      axis.line.y = element_line(colour = "black"),
      axis.line.y.right = element_blank(),
  
      panel.grid.minor.x = element_blank(),
      panel.grid.minor.y = element_blank(),
      strip.background = element_blank(),
      strip.placement = "outside",
      strip.text.y.left = element_text(angle = 0),
  
      panel.spacing = unit(0.8, "lines"),
  
      plot.title = element_text(hjust = 0),
      plot.title.position = "plot",
      plot.caption.position = "plot",
      plot.caption = element_text(hjust = 0, face= "italic"),
  
      legend.position = "none"
     ) +
    NULL
  
  plot_hazards
  
```

\newpage


#### Figure 2b: Estimated booster effectiveness (2 period split at 28 days)

For each outcome based on the fully adjusted model, the period-specific hazard ratios for boosting with BNT162b2 versus not boosting is shown, stratified by primary course.

```{r plot_effects28, echo=FALSE, message=FALSE, warning=FALSE, out.extra='', fig.height=7.5, out.width='90%', results='asis'}

formatpercent100 <- function(x,accuracy){
  formatx <- scales::label_percent(accuracy, suffix="")(x)

  if_else(
    formatx==scales::label_percent(accuracy, suffix="")(1),
    paste0(">",scales::label_percent(1, suffix="")((100-accuracy)/100)),
    formatx
  )
}
 ## hazard ratio

  y_breaks <- c(0.01, 0.02, 0.05, 0.1, 0.2, 0.5, 1, 2)

  
  overallhazards_plotdata <- 
    overallhazards %>%
    filter(
      model==3, 
      outcome %in% outcomes,
      treatment %in% c("pfizer"),
      subgroup_variable %in% c("none", "vax12_type")
    )
  
  postbaselinecuts28 <- c(0,28,70)
  
  plot_hazards <-
    meta28hazards %>%
    filter(
      model==3,
      outcome %in% outcomes,
      treatment %in% c("pfizer"),
      subgroup_variable %in% c("none", "vax12_type")
    ) %>%
    ggplot()+
    geom_point(aes(y=hr, x=term_midpoint, colour=model_descr), position = position_dodge(width = 1.8))+
    geom_linerange(aes(ymin=hr.ll, ymax=hr.ul, x=term_midpoint, colour=model_descr), position = position_dodge(width = 1.8))+
    geom_point(data = overallhazards_plotdata, mapping = aes(y=hr, x=max(postbaselinecuts28+14)), colour="darkgrey") +
    geom_linerange(data = overallhazards_plotdata, mapping = aes(ymin=hr.ll, ymax=hr.ul, x=max(postbaselinecuts28+14)), colour="darkgrey") +
    geom_rect(data = overallhazards_plotdata, ymin=-Inf, ymax=Inf, xmin=max(postbaselinecuts28+14)-7, xmax=max(postbaselinecuts28+14)+7, fill="grey95", alpha=0.5, colour="transparent") +
    geom_hline(aes(yintercept=1), colour='grey')+
    facet_grid(rows=vars(outcome_descr_wrap), cols=vars(subgroup_level_descr), switch="y")+
    scale_y_log10(
      breaks=y_breaks,
      limits = c(0.01, 1.5),
      oob = scales::oob_keep,
      sec.axis = sec_axis(
        ~(1-.),
        name="Effectiveness (%)",
        breaks = 1-(y_breaks),
        labels = function(x){formatpercent100(x, 1)}
      )
    )+
    scale_x_continuous(breaks=c(postbaselinecuts28, max(postbaselinecuts28+14)), labels=c(postbaselinecuts28, "Overall"), limits=c(min(postbaselinecuts28), max(postbaselinecuts28+14)+14), expand = c(0, 0))+
    scale_colour_brewer(type="qual", palette="Set2", guide=guide_legend(ncol=1))+
    labs(
      y="Hazard ratio",
      x="Days since booster dose",
      colour=NULL
     ) +
    theme_minimal()+
    theme(
      panel.border = element_blank(),
      axis.line.y = element_line(colour = "black"),
      axis.line.y.right = element_blank(),
  
      panel.grid.minor.x = element_blank(),
      panel.grid.minor.y = element_blank(),
      strip.background = element_blank(),
      strip.placement = "outside",
      strip.text.y.left = element_text(angle = 0),
  
      panel.spacing = unit(0.8, "lines"),
  
      plot.title = element_text(hjust = 0),
      plot.title.position = "plot",
      plot.caption.position = "plot",
      plot.caption = element_text(hjust = 0, face= "italic"),
  
      legend.position = "none"
     ) +
    NULL
  plot_hazards
  
```


\newpage 


#### Figure 2c: Estimated booster effectiveness (2 period split at 42 days)

For each outcome based on the fully adjusted model, the period-specific hazard ratios for boosting with BNT162b2 versus not boosting is shown, stratified by primary course.

```{r plot_effects42, echo=FALSE, message=FALSE, warning=FALSE, out.extra='', fig.height=7.5, out.width='90%', results='asis'}

formatpercent100 <- function(x,accuracy){
  formatx <- scales::label_percent(accuracy, suffix="")(x)

  if_else(
    formatx==scales::label_percent(accuracy, suffix="")(1),
    paste0(">",scales::label_percent(1, suffix="")((100-accuracy)/100)),
    formatx
  )
}
 ## hazard ratio

  y_breaks <- c(0.01, 0.02, 0.05, 0.1, 0.2, 0.5, 1, 2)

  
  overallhazards_plotdata <- 
    overallhazards %>%
    filter(
      model==3, 
      outcome %in% outcomes,
      treatment %in% c("pfizer"),
      subgroup_variable %in% c("none", "vax12_type")
    )
  
  postbaselinecuts42 <- c(0,42,70)
  
  plot_hazards <-
    meta42hazards %>%
    filter(
      model==3,
      outcome %in% outcomes,
      treatment %in% c("pfizer"),
      subgroup_variable %in% c("none", "vax12_type")
    ) %>%
    ggplot()+
    geom_point(aes(y=hr, x=term_midpoint, colour=model_descr), position = position_dodge(width = 1.8))+
    geom_linerange(aes(ymin=hr.ll, ymax=hr.ul, x=term_midpoint, colour=model_descr), position = position_dodge(width = 1.8))+
    geom_point(data = overallhazards_plotdata, mapping = aes(y=hr, x=max(postbaselinecuts42+14)), colour="darkgrey") +
    geom_linerange(data = overallhazards_plotdata, mapping = aes(ymin=hr.ll, ymax=hr.ul, x=max(postbaselinecuts42+14)), colour="darkgrey") +
    geom_rect(data = overallhazards_plotdata, ymin=-Inf, ymax=Inf, xmin=max(postbaselinecuts42+14)-7, xmax=max(postbaselinecuts42+14)+7, fill="grey95", alpha=0.5, colour="transparent") +
    geom_hline(aes(yintercept=1), colour='grey')+
    facet_grid(rows=vars(outcome_descr_wrap), cols=vars(subgroup_level_descr), switch="y")+
    scale_y_log10(
      breaks=y_breaks,
      limits = c(0.01, 1.5),
      oob = scales::oob_keep,
      sec.axis = sec_axis(
        ~(1-.),
        name="Effectiveness (%)",
        breaks = 1-(y_breaks),
        labels = function(x){formatpercent100(x, 1)}
      )
    )+
    scale_x_continuous(breaks=c(postbaselinecuts42, max(postbaselinecuts42+14)), labels=c(postbaselinecuts42, "Overall"), limits=c(min(postbaselinecuts42), max(postbaselinecuts42+14)+14), expand = c(0, 0))+
    scale_colour_brewer(type="qual", palette="Set2", guide=guide_legend(ncol=1))+
    labs(
      y="Hazard ratio",
      x="Days since booster dose",
      colour=NULL
     ) +
    theme_minimal()+
    theme(
      panel.border = element_blank(),
      axis.line.y = element_line(colour = "black"),
      axis.line.y.right = element_blank(),
  
      panel.grid.minor.x = element_blank(),
      panel.grid.minor.y = element_blank(),
      strip.background = element_blank(),
      strip.placement = "outside",
      strip.text.y.left = element_text(angle = 0),
  
      panel.spacing = unit(0.8, "lines"),
  
      plot.title = element_text(hjust = 0),
      plot.title.position = "plot",
      plot.caption.position = "plot",
      plot.caption = element_text(hjust = 0, face= "italic"),
  
      legend.position = "none"
     ) +
    NULL

  plot_hazards
  
```

\newpage


## Figure 3: Kaplan-Meier incidence curves

```{r plot_km, echo=FALSE, message=FALSE, warning=FALSE, out.extra='', fig.height=7.5, out.width='90%', results='asis'}

plot_km <- km %>%
  filter(
    outcome %in% outcomes,
    treatment=="pfizer",
    subgroup_variable %in% c("none", "vax12_type")
  ) %>%
    ggplot()+
    geom_step(aes(x=time, y=(1-surv)*1000, group=treated_descr, colour=treated_descr))+
    geom_rect(aes(xmin=time, xmax=leadtime, ymin=(1-surv.ll)*1000, ymax=(1-surv.ul)*1000, group=treated_descr, fill=treated_descr), alpha=0.1)+
    geom_hline(aes(yintercept=0), colour='black')+
    facet_grid(rows=vars(outcome_descr_wrap), cols=vars(subgroup_level_descr), switch="y", scales="free_y")+
    scale_x_continuous(
      breaks = seq(0,7*max(postbaselinecuts),by=14),
      expand = expansion(0)
    )+
    scale_y_continuous(
      expand = expansion(0),
      #limits = c(0L,NA)
    )+
    scale_colour_brewer(type="qual", palette="Set1", na.value="grey")+
    scale_fill_brewer(type="qual", palette="Set1", guide="none", na.value="grey")+
    labs(
      x=NULL,
      y="Cumulative incidence\nper 1000",
      colour=NULL
    )+
    theme_minimal()+
    theme(
      legend.position=c(0.05,0.85),
      legend.justification = c(0,0),
      legend.direction = "vertical",
      axis.text.x.top=element_text(hjust=0),

      strip.placement = "outside",
      strip.background = element_blank(),
      strip.text.y.left = element_text(angle = 0),

      panel.border = element_blank(),
      axis.line.y = element_line(colour = "black"),
      axis.line.x.top = element_line(colour = "black"),
      panel.grid.minor.x = element_blank(),
      panel.grid.minor.y = element_blank(),

      panel.spacing = unit(0.8, "lines"),

    )+
    NULL

plot_km


```
