---
title: "Effectiveness of COVID-19 Booster doses in England: a sequential trials study in OpenSAFELY: Supplementary materials"
output:
  html_document:
    keep_md: yes
    self_contained: yes
  word_document: default
  bookdown::html_document2:
    number_sections: no
    toc: no
  pdf_document:
    toc: no
header-includes:
- \usepackage{float} 
- \floatplacement{figure}{H}
bibliography: references.bib
---

```{r setup, include=FALSE}

library('tidyverse')
library('here')
library('glue')
library('lubridate')
library('gt')
library('patchwork')
library('scales')
source(here("lib", "functions", "utility.R"))

# where are the outputs (ie the inputs for this manuscript!) saved?
#output_dir_os <- here("output", "manuscript-objects")
output_dir_os <- here("released_output",  "manuscript-objects")

# where should we put the objects created within this rmd script?
output_dir_rmd <- here("manuscript", "figures")
fs::dir_create(output_dir_rmd)

# only applicable if `self-contained: yes` option is enables in yaml header
knitr::opts_chunk$set(
  echo = TRUE,
  fig.path = paste0(output_dir_rmd, "/"),
  fig.pos = 'H' #to stop figures floating around when rendering to pdf
)

study_dates <-
  jsonlite::read_json(path=here("lib", "design", "study-dates.json")) %>%
  map(as.Date)

postbaselinecuts <- read_rds(here("lib", "design", "postbaselinecuts.rds"))

matchsummary <- read_csv(fs::path(output_dir_os, "matchsummary.csv"))
matchsummary_treated <- read_csv(fs::path(output_dir_os, "matchsummary_treated.csv")) %>% filter(treated == 1L)
matchsummary_control <- read_csv(fs::path(output_dir_os, "matchsummary_treated.csv")) %>% filter(treated == 0L)
matchcoverage <- read_csv(fs::path(output_dir_os, "matchcoverage.csv"))
matchflowchart <- read_csv(fs::path(output_dir_os, "matchflowchart.csv"))
incidences <- read_csv(fs::path(output_dir_os, "none", "incidence_all.csv")) %>% mutate(events=events_1+events_0)
smd <- read_csv(fs::path(output_dir_os, "matchsmd.csv")) 

```


```{r, effects, echo=FALSE, message=FALSE, warning=FALSE}

  specify_decimal <- function(x, k, trim=FALSE) {
  
    fmtd <- format(round(x, k), nsmall = k)
    if (trim) {fmtd <- trimws(fmtd)}
    return(fmtd)
  }
  #
  # print_est1bracket <- function(x, b, round=1){
  #   paste0(specify_decimal(x, round), " (", specify_decimal(b, round), ")")
  # }
  #
  print_est2bracket <- function(x, b1, b2, round=1){
    paste0(specify_decimal(x, round), " (", specify_decimal(b1, round), ", ", specify_decimal(b2, round), ")")
  }

  outcomes <- 
    c(
      "postest",
      #"covidemergency",
      "covidadmitted",
      #"covidcc",
      "coviddeath",
      "noncoviddeath"
    ) %>% 
    set_names(., .)

# 
# cmlinc <- read_csv(fs::path(output_dir_os, "cmlinc.csv")) %>%
#   mutate(
#     treatment_descr = fct_inorder(treatment_descr),
#     outcome_descr = fct_inorder(outcome_descr),
#     model_name = fct_inorder(str_wrap(model_name, 15)),
#     inc_CI_to = paste0(label_number(0.1, scale=1000)(1-survival.ul), " to ", label_number(0.1, scale=1000)(1-survival.ll))
#   )

# riskdiff <- read_csv(fs::path(output_dir_os, "riskdiff.csv")) %>%
#   mutate(
#     treatment_descr = fct_inorder(treatment_descr),
#     outcome_descr = fct_inorder(outcome_descr),
#     model_name = fct_inorder(str_wrap(model_name, 15)),
#     diff_CI_to = paste0(label_number(0.01, scale=1000)(diff.ll), " to ", label_number(0.01, scale=1000)(diff.ul))
#   )
  

km <- 
  bind_rows(
    read_csv(fs::path(output_dir_os, "none", "km.csv")),
    read_csv(fs::path(output_dir_os, "vax12_type", "km.csv")) ,
    #read_csv(fs::path(output_dir_os, "cev", "km.csv")) ,
    #read_csv(fs::path(output_dir_os, "age65plus", "km.csv")) ,
  ) %>%
  mutate(
    subgroup_descr = fct_inorder(subgroup_descr),
    subgroup_level = fct_inorder(subgroup_level),
    subgroup_level_descr = fct_inorder(fct_explicit_na(subgroup_level_descr, "All")),
    treatment_descr = fct_inorder(treatment_descr),
    outcome_descr = fct_inorder(outcome_descr),
    outcome_descr_wrap = fct_relabel(outcome_descr, ~str_wrap(., width=20)),
    #model_name = fct_inorder(str_wrap(model_name, 15)),
  )

hazards <- 
  bind_rows(
    read_csv(fs::path(output_dir_os, "none", "effects.csv")),
    read_csv(fs::path(output_dir_os, "vax12_type", "effects.csv")),
    #read_csv(fs::path(output_dir_os, "cev", "effects.csv")),
    #read_csv(fs::path(output_dir_os, "age65plus", "effects.csv")),
  ) %>%
  mutate(
    
    subgroup_descr = fct_inorder(subgroup_descr),
    subgroup_level = fct_inorder(subgroup_level),
    subgroup_level_descr = fct_inorder(fct_explicit_na(subgroup_level_descr, "All")),
    treatment_descr = fct_inorder(treatment_descr),
    outcome_descr = fct_inorder(outcome_descr),
    outcome_descr_wrap = fct_relabel(outcome_descr, ~str_wrap(., width=20)),
    #model_name = fct_inorder(str_wrap(model_name, 15)),
    hr_display = paste0(label_number(accuracy=0.01)(hr), " (", label_number(accuracy=0.01)(hr.ll), "-", label_number(accuracy=0.01)(hr.ul), ")"),
    ve_display = paste0(label_percent(accuracy=0.1)(ve), " (", label_percent(accuracy=0.1, suffix="")(ve.ll), "-", label_percent(accuracy=0.1, suffix="")(ve.ul), ")"),
  )




```
\newpage


# Matching details

Booster eligibility was dependent on vaccine priority group, largely determined by clinical vulnerability and age. Booster doses were initially available 6 months after administration of the second dose, later reduced to 3 months following concerns over the surge in cases and the emergence of the seemingly more transmissible Omicron variant. Determining vaccine eligibility for a given person on a given day is therefore complex. To avoid these complexities, we determined trial eligibility for each person on each day of recruitment by ensuring that there were sufficiently many people with similar characteristics who were being vaccinated on that day. Specifically, a rolling weekly average was calculated within strata defined by region, priority group, and week of second vaccine dose. If fewer than 50 people had been vaccinated within each strata on each day, then that strata was not eligible for recruitment on that day.

The Joint Committee on Vaccine and Immunisation (JCVI) priority groups were defined as follows:


```{r, jcvi, echo=FALSE, message=FALSE, warning=FALSE}

tibble(
  `Priority group` = c("1", "2", "3", "4", "5", "6", "7", "8", "9", "10a", "10b"),
  `Description` = c(
    "Residents in a care home for older adults\nStaff working in care homes for older adults",
    "All those 80 years of age and over\nFrontline health and social care workers",
    "All those 75-79 years of age",
    "All those 70-74 years of age\nIndividuals aged 16-69 in a high risk group",
    "All those 65-69 years of age",
    "Adults aged 16-64 years in an at-risk group",
    "All those 60-64 years of age",
    "All those 55-59 years of age",
    "All those 50-54 years of age",
    "All those 40-49 years of age",
    "All those 18-39 years of age"
  )
) %>%
mutate(Description = str_replace_all(Description, "\n", "<br>")) %>% 
gt() %>% 
fmt_markdown(columns = TRUE)


```

See original priority groups here: https://assets.publishing.service.gov.uk/government/uploads/system/uploads/attachment_data/file/1007737/Greenbook_chapter_14a_30July2021.pdf#page=15
See revised priority groups here: https://www.england.nhs.uk/coronavirus/wp-content/uploads/sites/52/2021/07/C1327-covid-19-vaccination-autumn-winter-phase-3-planning.pdf

Note that we excluded care home residents and health care workers in our analysis, so members of JCVI group 1 are not included and JCVI group 2 includes only those aged 80 and over. The original priority group list has 9 groups, with a 10th group implicitly defined as "everybody else". Here we explicitly define this group, and split into two (10a and 10b) because of the earlier booster eligiblity in the 40-49 group from 15 November 2021 onwards. (https://www.gov.uk/government/news/jcvi-issues-advice-on-covid-19-booster-vaccines-for-those-aged-40-to-49-and-second-doses-for-16-to-17-year-olds)


# Variables and codelists

```{r, codelists, echo=FALSE, message=FALSE, warning=FALSE}

variable_table <- readxl::read_xlsx(here("lib", "design", "variable-descriptions.xlsx"))

variable_table %>%
  gt(groupname_col = "category") %>%
  cols_label(
    name = "Variable",
    source = "Data source",
    description = "Notes",
    support = "Values ",
    codelistID = "Codelist identifier"
  ) %>%
   fmt_missing(
    everything(),
    missing_text=""
  )
  


```


Codelists can be found at `https://codelists.opensafely.org/codelist/<ID>`, substituting `<ID>` for the codelist identifier in the table above.

### Table S1: Inclusion criteria

```{r flowchart, echo=FALSE, warning=FALSE, message=FALSE}

matchflowchart %>%
  transmute(
    treatment,
    stage,
    criteria = str_wrap(criteria, 40),
    n,
    n_exclude,
    pct_all
  ) %>%
  pivot_wider(
    id_cols = c(stage, criteria),
    names_from = treatment,
    values_from = c(n, n_exclude, pct_all)
  ) %>%
  gt() %>%
  cols_label(
    stage="",
    criteria = "",
    
    n_pfizer = "N",
    #n_moderna = "N",

    n_exclude_pfizer = "N excluded",
    #n_exclude_moderna = "N excluded",
    
    pct_all_pfizer = "% remaining",
    #pct_all_moderna = "% remaining",
  ) %>%
  tab_spanner(
    label = "BNT162b2",
    columns = ends_with("pfizer")
  ) %>%
  # tab_spanner(
  #   label = "mRNA-1273",
  #   columns = ends_with("moderna")
  # ) %>%
  fmt_percent(
    columns = starts_with(c("pct_")),
    decimals = 1
  ) %>%
  fmt_number(
    columns = starts_with(c("n_")),
    decimals= 0
  ) %>%
  fmt_missing(
    everything(),
    missing_text="-"
  ) %>%
  tab_style(
    style=cell_text(whitespace ="pre-wrap"),
    #style=cell_text(style ="italic"),
    locations = cells_body(columns = "criteria")
  )
```

\newpage



### Figure S1: Standardised Mean Differences between Boosted and Unboosted groups


```{r plot_smd, echo=FALSE, message=FALSE, warning=FALSE, out.extra='', fig.height=7.5, out.width='90%', results='asis'}

plot_smd <-
  smd %>%
  mutate(
    level=fct_rev(fct_inorder(level))
  ) %>%
  ggplot()+
  geom_point(aes(x=smd, y=level))+
  geom_rect(aes(alpha = variable_card, ymin = rev(cardn)-0.5, ymax =rev(cardn+0.5)), xmin = -Inf, xmax = Inf, fill='grey', colour="transparent") +
  scale_alpha_continuous(range=c(0,0.3), guide=FALSE)+
  labs(
    x="Standardised mean difference",
    y=NULL,
    alpha=NULL
  )+
  theme_minimal() +
  theme(
    strip.placement = "outside",
    strip.background = element_rect(fill="transparent", colour="transparent"),
    strip.text.y.left = element_text(angle = 0, hjust=1),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    panel.spacing = unit(0, "lines")
  )

plot_smd


```


### Figure S2: Kaplan-Meier cumulative incidence curves

```{r plot_km, echo=FALSE, message=FALSE, warning=FALSE, out.extra='', fig.height=7.5, out.width='90%', results='asis'}

plot_km <- km %>%
  filter(
    outcome %in% outcomes,
    treatment=="pfizer"
  ) %>%
    ggplot()+
    geom_step(aes(x=time, y=(1-surv)*1000, group=treated_descr, colour=treated_descr))+
    geom_rect(aes(xmin=time, xmax=leadtime, ymin=(1-surv.ll)*1000, ymax=(1-surv.ul)*1000, group=treated_descr, fill=treated_descr), alpha=0.1)+
    geom_hline(aes(yintercept=0), colour='black')+
    facet_grid(rows=vars(outcome_descr_wrap), cols=vars(subgroup_level_descr), switch="y", scales="free_y")+
    scale_x_continuous(
      breaks = seq(0,7*max(postbaselinecuts),by=14),
      expand = expansion(0)
    )+
    scale_y_continuous(
      expand = expansion(0),
      #limits = c(0L,NA)
    )+
    scale_colour_brewer(type="qual", palette="Set1", na.value="grey")+
    scale_fill_brewer(type="qual", palette="Set1", guide="none", na.value="grey")+
    labs(
      x=NULL,
      y="Cumulative incidence\nper 1000",
      colour=NULL
    )+
    theme_minimal()+
    theme(
      legend.position=c(0.15,0.85),
      legend.justification = c(1,0),
      legend.direction = "vertical",
      axis.text.x.top=element_text(hjust=0),

      strip.placement = "outside",
      strip.background = element_blank(),
      strip.text.y.left = element_text(angle = 0),

      panel.border = element_blank(),
      axis.line.y = element_line(colour = "black"),
      axis.line.x.top = element_line(colour = "black"),
      panel.grid.minor.x = element_blank(),
      panel.grid.minor.y = element_blank(),

      panel.spacing = unit(0.8, "lines"),

    )+
    NULL

plot_km


```

\newpage

## Figure S3: Estimated booster effectiveness, all models


```{r plot_effects, echo=FALSE, message=FALSE, warning=FALSE, out.extra='', fig.height=7.5, out.width='90%', results='asis'}

formatpercent100 <- function(x,accuracy){
  formatx <- scales::label_percent(accuracy)(x)

  if_else(
    formatx==scales::label_percent(accuracy)(1),
    paste0(">",scales::label_percent(1)((100-accuracy)/100)),
    formatx
  )
}

  ## hazard ratio


  y_breaks <- c(0.01, 0.02, 0.05, 0.1, 0.2, 0.5, 1, 2)

  plot_hazards <-
    hazards %>%
    filter(
      outcome %in% outcomes,
      treatment %in% c("pfizer")
    ) %>%
    ggplot()+
    geom_point(aes(y=hr, x=term_midpoint, colour=model_descr), position = position_dodge(width = 1.8))+
    geom_linerange(aes(ymin=hr.ll, ymax=hr.ul, x=term_midpoint, colour=model_descr), position = position_dodge(width = 4))+
    geom_hline(aes(yintercept=1), colour='grey')+
    facet_grid(rows=vars(outcome_descr_wrap), cols=vars(subgroup_level_descr), switch="y")+
    scale_y_log10(
      breaks=y_breaks,
      limits = c(0.01, 1.5),
      oob = scales::oob_keep,
      sec.axis = sec_axis(
        ~(1-.),
        name="Effectiveness (%)",
        breaks = 1-(y_breaks),
        labels = function(x){formatpercent100(x, 1)}
      )
    )+
    scale_x_continuous(breaks=postbaselinecuts, limits=c(min(postbaselinecuts), max(postbaselinecuts)+1), expand = c(0, 0))+
    scale_colour_brewer(type="qual", palette="Set2", guide=guide_legend(ncol=1))+
    labs(
      y="Hazard ratio",
      x="Days since booster dose",
      colour=NULL
     ) +
    theme_minimal()+
    theme(
      panel.border = element_blank(),
      axis.line.y = element_line(colour = "black"),
      axis.line.y.right = element_blank(),
  
      panel.grid.minor.x = element_blank(),
      panel.grid.minor.y = element_blank(),
      strip.background = element_blank(),
      strip.placement = "outside",
      strip.text.y.left = element_text(angle = 0),
  
      panel.spacing = unit(0.8, "lines"),
  
      plot.title = element_text(hjust = 0),
      plot.title.position = "plot",
      plot.caption.position = "plot",
      plot.caption = element_text(hjust = 0, face= "italic"),
  
      legend.position = "none"
     ) +
    NULL


  plot_hazards


```


\newpage
