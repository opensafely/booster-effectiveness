---
title: "Effectiveness of BNT162b2 booster doses in England: a observational study in OpenSAFELY-TPP"
output:
  html_document:
    self_contained: yes
  pdf_document:
    toc: no
  bookdown::html_document2:
    number_sections: no
    toc: no
  rtf_document:
    toc: no
  word_document: default
bibliography: references.bib
csl: vancouver.csl
link-citations: yes
zotero: yes
header-includes:
- \usepackage{float} 
- \floatplacement{figure}{H}
- \usepackage{caption}
- \captionsetup[figure]{labelformat=empty}
- \captionsetup[table]{labelformat=empty}
---

```{r setup, include=FALSE}

library('tidyverse')
library('here')
library('glue')
library('lubridate')
library('gt')
library('patchwork')
library('scales')
source(here("lib", "functions", "utility.R"))

# where are the outputs (ie the inputs for this manuscript!) saved?
#output_dir_os <- here("output", "manuscript-objects")
output_dir_os <- here("released_output", "manuscript-objects")

# where should we put the objects created within this rmd script?
output_dir_rmd <- here("manuscript", "figures")
fs::dir_create(output_dir_rmd)

# only applicable if `self-contained: yes` option is enables in yaml header
knitr::opts_chunk$set(
  echo = TRUE,
  fig.path = paste0(output_dir_rmd, "/"),
  fig.pos = 'H' #to stop figures floating around when rendering to pdf
)

study_dates <-
  jsonlite::read_json(path=here("lib", "design", "study-dates.json")) %>%
  map(as.Date)

postbaselinecuts <- read_rds(here("lib", "design", "postbaselinecuts.rds"))

cohortsummary <- read_csv(fs::path(output_dir_os, "cohortsummary.csv"))
matchsummary <- read_csv(fs::path(output_dir_os, "matchsummary.csv"))
matchsummary_treated <- read_csv(fs::path(output_dir_os, "matchsummary_treated.csv")) %>% filter(treated == 1L)
matchsummary_control <- read_csv(fs::path(output_dir_os, "matchsummary_treated.csv")) %>% filter(treated == 0L)
matchflowchart <- read_csv(fs::path(output_dir_os, "matchflowchart.csv"))
matchcoverage <- read_csv(fs::path(output_dir_os, "matchcoverage.csv"))
incidences <- read_csv(fs::path(output_dir_os, "none", "incidence_all.csv")) %>% mutate(events=events_1+events_0)
pfizerdurationweeks <- as.numeric(as.duration(study_dates$pfizerend_date - study_dates$pfizerstart_date +1) , "weeks")
```

```{r, effects, echo=FALSE, message=FALSE, warning=FALSE}

  specify_decimal <- function(x, k, trim=FALSE) {
  
    fmtd <- format(round(x, k), nsmall = k)
    if (trim) {fmtd <- trimws(fmtd)}
    return(fmtd)
  }
  #
  # print_est1bracket <- function(x, b, round=1){
  #   paste0(specify_decimal(x, round), " (", specify_decimal(b, round), ")")
  # }
  #
  print_est2bracket <- function(x, b1, b2, round=1){
    paste0(specify_decimal(x, round), " (", specify_decimal(b1, round), ", ", specify_decimal(b2, round), ")")
  }

  outcomes <- 
    c(
      "postest",
      #"covidemergency",
      "covidadmitted",
      #"covidcc",
      "coviddeath",
      "noncoviddeath"
    ) %>% 
    set_names(., .)

  
# incidence <- 
#   bind_rows(
#     read_csv(fs::path(output_dir_os, "none", "incidence.csv")),
#     read_csv(fs::path(output_dir_os, "vax12_type", "incidence.csv")),
#     read_csv(fs::path(output_dir_os, "cev", "incidence.csv")) %>% mutate(subgroup_level=as.character(subgroup_level)),
#     read_csv(fs::path(output_dir_os, "age65plus", "incidence.csv")) %>% mutate(subgroup_level=as.character(subgroup_level))
#   ) %>%
#   filter(
#     outcome %in% outcomes
#   ) %>%
#   mutate(
#     subgroup_descr = fct_inorder(subgroup_descr),
#     subgroup_level = fct_inorder(subgroup_level),
#     subgroup_level_descr = fct_inorder(fct_explicit_na(subgroup_level_descr, "All")),
#     treatment_descr = fct_inorder(treatment_descr),
#     outcome_descr = fct_inorder(outcome_descr),
#     outcome_descr_wrap = fct_relabel(outcome_descr, ~str_wrap(., width=15)),
#     #model_name = fct_inorder(str_wrap(model_name, 15)),
#   )

km <- 
  bind_rows(
    read_csv(fs::path(output_dir_os, "none", "km.csv")),
    read_csv(fs::path(output_dir_os, "vax12_type", "km.csv")),
    read_csv(fs::path(output_dir_os, "cev", "km.csv")) %>% mutate(subgroup_level=as.character(subgroup_level)),
    read_csv(fs::path(output_dir_os, "age65plus", "km.csv")) %>% mutate(subgroup_level=as.character(subgroup_level))
  ) %>%
  filter(
    outcome %in% outcomes
  ) %>%
  mutate(
    subgroup_descr = fct_inorder(subgroup_descr),
    subgroup_level = fct_inorder(subgroup_level),
    subgroup_level_descr = fct_inorder(fct_explicit_na(subgroup_level_descr, "All")),
    treatment_descr = fct_inorder(treatment_descr),
    outcome_descr = fct_inorder(outcome_descr),
    outcome_descr_wrap = fct_relabel(outcome_descr, ~str_wrap(., width=15)),
    #model_name = fct_inorder(str_wrap(model_name, 15)),
  )



km70 <- km %>% 
  filter(leadtime==max(postbaselinecuts)) %>%
  mutate(
    treated=(treated_descr=="Boosted")*1L
  ) %>%
  select(
    treatment, outcome , subgroup, 
    treated, surv
  ) %>%
  pivot_wider(
    id_cols= c("treatment", "outcome", "subgroup"),
    names_from=treated,
    names_prefix="surv_",
    values_from=surv
  ) %>%
  mutate(
    risk_1 = 1 - surv_1,
    risk_0 = 1 - surv_0,
    
    kmrr = risk_1 / risk_0,
    kmrd = risk_1 - risk_0,
    VErr = 1-kmrr,
    kmrrE = label_number(accuracy=0.01, scale=1)(kmrr),
    kmrdE = label_number(accuracy=0.01, scale=1000)(kmrd)
  )

# 
# cmlinc <- read_csv(fs::path(output_dir_os, "cmlinc.csv")) %>%
#   mutate(
#     treatment_descr = fct_inorder(treatment_descr),
#     outcome_descr = fct_inorder(outcome_descr),
#     model_name = fct_inorder(str_wrap(model_name, 15)),
#     inc_CI_to = paste0(label_number(0.1, scale=1000)(1-survival.ul), " to ", label_number(0.1, scale=1000)(1-survival.ll))
#   )

# riskdiff <- read_csv(fs::path(output_dir_os, "riskdiff.csv")) %>%
#   mutate(
#     treatment_descr = fct_inorder(treatment_descr),
#     outcome_descr = fct_inorder(outcome_descr),
#     model_name = fct_inorder(str_wrap(model_name, 15)),
#     diff_CI_to = paste0(label_number(0.01, scale=1000)(diff.ll), " to ", label_number(0.01, scale=1000)(diff.ul))
#   )


hazards <- 
  bind_rows(
    read_csv(fs::path(output_dir_os, "none", "effects.csv")),
    read_csv(fs::path(output_dir_os, "vax12_type", "effects.csv")),
    read_csv(fs::path(output_dir_os, "cev", "effects.csv")) %>% mutate(subgroup_level=as.character(subgroup_level)),
    read_csv(fs::path(output_dir_os, "age65plus", "effects.csv"))  %>% mutate(subgroup_level=as.character(subgroup_level)),
  ) %>%
  filter(
    outcome %in% outcomes
  ) %>%
  mutate(
    
    subgroup_descr = fct_inorder(subgroup_descr),
    subgroup_level = fct_inorder(subgroup_level),
    subgroup_level_descr = fct_inorder(fct_explicit_na(subgroup_level_descr, "All")),
    treatment_descr = fct_inorder(treatment_descr),
    outcome_descr = fct_inorder(outcome_descr),
    outcome_descr_wrap = fct_relabel(outcome_descr, ~str_wrap(., width=15)),
    #model_name = fct_inorder(str_wrap(model_name, 15)),
    hr_display = paste0(label_number(accuracy=0.01)(hr), " (", label_number(accuracy=0.01)(hr.ll), "-", label_number(accuracy=0.01)(hr.ul), ")"),
    ve_display = paste0(label_percent(accuracy=0.1)(ve), " (", label_percent(accuracy=0.1, suffix="")(ve.ll), "-", label_percent(accuracy=0.1, suffix="")(ve.ul), ")"),
    ve_display95 = paste0(label_percent(accuracy=0.1)(ve), " (95% CI", label_percent(accuracy=0.1, suffix="")(ve.ll), "-", label_percent(accuracy=0.1, suffix="")(ve.ul), ")"),
  )

overallhazards <- 
  bind_rows(
    read_csv(fs::path(output_dir_os, "none", "overalleffects.csv")),
    read_csv(fs::path(output_dir_os, "vax12_type", "overalleffects.csv")),
    read_csv(fs::path(output_dir_os, "cev", "overalleffects.csv")) %>% mutate(subgroup_level=as.character(subgroup_level)),
    read_csv(fs::path(output_dir_os, "age65plus", "overalleffects.csv")) %>% mutate(subgroup_level=as.character(subgroup_level)),
  ) %>%
  filter(
    outcome %in% outcomes
  ) %>%
  mutate(
    
    subgroup_descr = fct_inorder(subgroup_descr),
    subgroup_level = fct_inorder(subgroup_level),
    subgroup_level_descr = fct_inorder(fct_explicit_na(subgroup_level_descr, "All")),
    treatment_descr = fct_inorder(treatment_descr),
    outcome_descr = fct_inorder(outcome_descr),
    outcome_descr_wrap = fct_relabel(outcome_descr, ~str_wrap(., width=15)),
    #model_name = fct_inorder(str_wrap(model_name, 15)),
    hr_display = paste0(label_number(accuracy=0.01)(hr), " (", label_number(accuracy=0.01)(hr.ll), "-", label_number(accuracy=0.01)(hr.ul), ")"),
    ve_display = paste0(label_percent(accuracy=0.1)(ve), " (", label_percent(accuracy=0.1, suffix="")(ve.ll), "-", label_percent(accuracy=0.1, suffix="")(ve.ul), ")"),
    ve_display95 = paste0(label_percent(accuracy=0.1)(ve), " (95% CI", label_percent(accuracy=0.1, suffix="")(ve.ll), "-", label_percent(accuracy=0.1, suffix="")(ve.ul), ")"),
  )


meta2hazards <- 
  # derive directly from hazards as meta2effects table needs to be re-run
  bind_rows(
    read_csv(fs::path(output_dir_os, "none", "effects.csv")),
    read_csv(fs::path(output_dir_os, "vax12_type", "effects.csv")),
    read_csv(fs::path(output_dir_os, "cev", "effects.csv")) %>% mutate(subgroup_level=as.character(subgroup_level)),
    read_csv(fs::path(output_dir_os, "age65plus", "effects.csv"))  %>% mutate(subgroup_level=as.character(subgroup_level)),
  ) %>%
  filter(
    outcome %in% outcomes
  ) %>%
  mutate(
    period = (term_right>28) + 1,
    subgroup_descr = fct_inorder(subgroup_descr),
    subgroup_level = fct_inorder(subgroup_level),
    subgroup_level_descr = fct_inorder(fct_explicit_na(subgroup_level_descr, "All")),
    treatment_descr = fct_inorder(treatment_descr),
    outcome_descr = fct_inorder(outcome_descr),
    outcome_descr_wrap = fct_relabel(outcome_descr, ~str_wrap(., width=15)),
  ) %>%
  group_by(
    treatment, treatment_descr, outcome, outcome_descr, outcome_descr_wrap, subgroup, subgroup_variable, subgroup_descr, subgroup_level, subgroup_level_descr, model, model_descr, period, 
  ) %>%
  summarise(
    term_left = min(term_left),
    term_right = max(term_right),
    term_midpoint = (term_left+term_right)/2,
    estimate = weighted.mean(estimate, robust.se^-2),
    std.error = sqrt(1/sum(std.error^-2)),
    robust.se = sqrt(1/sum(robust.se^-2)),
    statistic = estimate/robust.se,
    p.value = 2 * pmin(pnorm(statistic), pnorm(-statistic)),
    conf.low = estimate + qnorm(0.025)*robust.se,
    conf.high = estimate + qnorm(0.975)*robust.se,
    hr = exp(estimate),
    hr.ll = exp(conf.low),
    hr.ul = exp(conf.high),
    ve = 1-hr,
    ve.ll = 1-hr.ul,
    ve.ul = 1-hr.ll
  ) %>%
  ungroup() %>%
  mutate(
    hr_display = paste0(label_number(accuracy=0.01)(hr), " (", label_number(accuracy=0.01)(hr.ll), "-", label_number(accuracy=0.01)(hr.ul), ")"),
    ve_display = paste0(label_percent(accuracy=0.1)(ve), " (", label_percent(accuracy=0.1, suffix="")(ve.ll), "-", label_percent(accuracy=0.1, suffix="")(ve.ul), ")"),
    ve_display95 = paste0(label_percent(accuracy=0.1)(ve), " (95% CI", label_percent(accuracy=0.1, suffix="")(ve.ll), "-", label_percent(accuracy=0.1, suffix="")(ve.ul), ")"),
  )

# meta2hazards <- 
#   bind_rows(
#     read_csv(fs::path(output_dir_os, "none", "meta2effects.csv")),
#     read_csv(fs::path(output_dir_os, "vax12_type", "meta2effects.csv")),
#     read_csv(fs::path(output_dir_os, "cev", "meta2effects.csv")) %>% mutate(subgroup_level=as.character(subgroup_level)),
#     read_csv(fs::path(output_dir_os, "age65plus", "meta2effects.csv")) %>% mutate(subgroup_level=as.character(subgroup_level)),
#   ) %>%
#   filter(
#     outcome %in% outcomes
#   ) %>%
#   mutate(
#     subgroup_descr = fct_inorder(subgroup_descr),
#     subgroup_level = fct_inorder(subgroup_level),
#     subgroup_level_descr = fct_inorder(fct_explicit_na(subgroup_level_descr, "All")),
#     treatment_descr = fct_inorder(treatment_descr),
#     outcome_descr = fct_inorder(outcome_descr),
#     outcome_descr_wrap = fct_relabel(outcome_descr, ~str_wrap(., width=20)),
#     #model_name = fct_inorder(str_wrap(model_name, 15)),
#     hr_display = paste0(label_number(accuracy=0.01)(hr), " (", label_number(accuracy=0.01)(hr.ll), "-", label_number(accuracy=0.01)(hr.ul), ")"),
#     ve_display = paste0(label_percent(accuracy=0.1)(ve), " (", label_percent(accuracy=0.1, suffix="")(ve.ll), "-", label_percent(accuracy=0.1, suffix="")(ve.ul), ")"),
#   )

#cmlinc3 <- cmlinc %>% filter(model==3)
hazards3 <- hazards %>% filter(model==3)

riskdiff <- km %>% 
  group_by(treatment, treatment_descr, outcome, outcome_descr, outcome_descr_wrap, subgroup, subgroup_descr, subgroup_variable, subgroup_variable_descr, subgroup_level, subgroup_level_descr, time) %>%
  summarise(
    survdiff = diff(surv),
  ) %>% 
  mutate(
    survdiff_display = label_number(accuracy=0.1, scale=1000, big.mark =",")(survdiff),
    survdiff_inv_display = label_number(accuracy=0.1, scale=1000, big.mark =",")(-survdiff),
  ) %>%
  ungroup()
```

William J Hulme^1^, Elizabeth J Williamson^2^, Elsie Horne^3,4^, Amelia Green^1^, Linda Nab^1^, Ruth Keogh^2^, Edward PK Parker^2^, Venexia Walker^3,4^, Helen Curtis^1^, Milan Wiedemann^1^, Christine Cunningham^1^, Alex J Walker^1^, Louis Fisher^1^, Christopher T Rentsch^2^, Anna Schultze^2^, Krishnan Bhaskaran^2^, Helen I McDonald^2^, John Tazare^2^, Laurie Tomlinson^2^, Tom Palmer^3,4^, Brian MacKenna^1^, Richard Croker^1^, Caroline E Morton^1^, Colm Andrews^1^, Robin Parks^1^, Lisa Hopcroft^1^, Jon Massey^1^, Jessica Morley^1^, Amir Mehrkar^1^, Seb Bacon^1^, Dave Evans^1^, Peter Inglesby^1^, George Hickman^1^, Simon Davy^1^, Tom Ward^1^, Rosalind M Eggo^2^, Angel YS Wong^2^, Rohini Mathur^2^, Kevin Wing^2^, Harriet Forbes^2^, Daniel Grint^2^, Viyasaan Mahalingasivam^2^, Bang Zheng^2^, Ian J Douglas^2^, Stephen JW Evans^2^, Liam Smeeth^2^, Chris Bates^5^, Jonathan Cockburn^5^, John Parry^5^, Frank Hester^5^, Sam Harper^5^, Jonathan AC Sterne^3,4^, Miguel A Hernán^6,7^, Ben Goldacre^1^.

1\. The DataLab, Nuffield Department of Primary Care Health Sciences, University of Oxford, OX26GG, UK

2\. London School of Hygiene and Tropical Medicine, Keppel Street, London, WC1E 7HT, UK

3\. Population Health Sciences, University of Bristol, Oakfield House, Oakfield Grove, Bristol, BS8 2BN, UK

4\. NIHR Bristol Biomedical Research Centre, Bristol, UK

5\. TPP, TPP House, 129 Low Lane, Horsforth, Leeds, LS18 5PX

6\. CAUSALab, Harvard T.H. Chan School of Public Health, Boston, MA 02115

7\. Departments of Epidemiology and Biostatistics, Harvard T.H. Chan School of Public Health, Boston, MA 02115

\newpage

## Abstract

<!-- ### Standard -->

*Background*

The UK COVID-19 vaccination programme delivered its first "booster" doses in September 2021, initially in groups at high risk of severe disease then across the adult population. The BNT162b2 Pfizer-BioNTech vaccine was used initially, with Moderna mRNA-1273 subsequently also used.

*Methods*

We used the OpenSAFELY-TPP database, covering 40% of English primary care practices in England and linked to national coronavirus surveillance, hospital episodes, and death registry data, to estimate the effectiveness of BNT162b2 in eligible adults between `r format(as.Date(study_dates$pfizerstart_date), "%e %B")` and `r format(as.Date(study_dates$pfizerend_date), "%e %B %Y")`, a period when the Delta variant of SARS-CoV-2 was dominant. Follow up was for up to 10 weeks. Each booster recipient was matched with an unboosted control on factors relating to booster priority status and prior immunisation. Additional factors were adjusted for in a Cox model to estimate hazard ratios. Outcomes were positive SARS-CoV-2 test, COVID-19 hospital admission, COVID-19 death and non-COVID-9 death. Booster effectiveness was defined as 1 minus the hazard ratio.

*Results*

We matched `r label_number(1, big.mark=",")(filter(matchsummary, treatment=="pfizer") %>% pull(n_matched))` BNT162b2 booster recipients to unboosted controls. During the first 28 days after the booster, estimated booster effectiveness (95% CI) comparing a BNT162b2 booster dose to two doses only was `r filter(overallhazards, subgroup=="none", outcome=="postest", treatment=="pfizer", model==3) %>% pull(ve_display)` for positive SARS-CoV-2 test, `r filter(overallhazards, subgroup=="none", outcome=="covidadmitted", treatment=="pfizer", model==3) %>% pull(ve_display)` for COVID-19 hospital admission, `r filter(overallhazards, subgroup=="none", outcome=="coviddeath", treatment=="pfizer", model==3) %>% pull(ve_display)` for COVID-19 death, and `r filter(overallhazards, subgroup=="none", outcome=="noncoviddeath", treatment=="pfizer", model==3) %>% pull(ve_display)` for non-COVID-19 death.

*Conclusion*

We estimated high protection of BNT162b2 boosting against positive SARS-CoV-2 test, COVID-19 hospital admission, and COVID-19 death.

**Keywords** COVID-19; Booster vaccine effectiveness; Target trial; EHR data

<!-- *Objectives* To estimate the effectiveness of the BNT162b2 and mRNA-1273 mRNA-1273 booster COVID-19 vaccines against infection and COVID-19 disease. -->

<!-- *Design* Matched sequential trial design, emulating a series of parallel two-arm RCTs. -->

<!-- *Setting* Linked primary care, hospital, and COVID-19 surveillance records available within the OpenSAFELY-TPP research platform. -->

<!---# *Participants* `r label_number(1, big.mark=",")(filter(matchflowchart, crit=="c4") %>% pull(n))` people with a complete primary COVID-19 vaccine course, registered with a GP practice using the TPP SystmOne clinical information system in England. --->

<!-- *Interventions* A booster vaccination with either BNT162b2 or mRNA-1273 administered as part of the national COVID-19 booster vaccine roll-out. -->

<!-- *Main outcome measures* Recorded SARS-CoV-2 infection, COVID-19-related accident and emergency attendance, unplanned COVID-19-related hospital admission, and COVID-19-related death. -->

<!-- *Results* -->

<!-- *Conclusions* -->

\newpage

<!-- TODO -->

<!-- * check for moderna references and remove if necessary -->

<!-- * check final recruitment day and include in results -->

<!-- * check if rolling average restrictions are ever used (need to output dataset) -->

<!-- * references -->

# Introduction

In mid-September 2021, the national COVID-19 vaccination programme in England administered its first booster doses in adults who had already received their two-dose primary vaccination course @NHSEnglandNHS. Eligibility was initially restricted to those at highest risk of severe disease, then progressively extended. By 15 December 2021 every adult was eligible @NHSEnglandNHSb. Booster doses were initially available no earlier than six months after dose two, but this was reduced to three months on 8 December 2021, following concerns over the emergence of the Omicron variant @NHSEnglandNHSa1 @NHSEnglandNHSa2. Vaccine prioritisation schedules were guided by recommendations from the Joint Committee for Vaccine and Immunisation (JCVI) expert working group.

<!-- https://www.england.nhs.uk/2021/09/nhs-begins-covid-19-booster-vaccination-campaign/ -->

<!-- 13 december 30-39 become eligible (https://www.england.nhs.uk/2021/12/nhs-to-roll-out-life-saving-booster-jab-to-people-aged-30-plus/) -->

<!-- 15 december everyone eligible https://www.england.nhs.uk/2021/12/nhs-booster-bookings-open-to-every-eligible-adult/ -->

<!-- In most cases, BNT162b2 and half-dose mRNA-1273 vaccines were used for boosting, and administered regardless of the first and second dose brand. BNT162b2 was used from 16 September 2021, and mRNA-1273 from 29 October 2021 onwards. This provides an opportunity to investigate booster effectiveness of two different brands administered in overlapping periods and community contexts, as well as in subgroups defined by prior immunological and other clinical factors.-->

We aimed to emulate a target trial assessing the effectiveness of booster vaccination with BNT162b2 against COVID-19 outcomes @dagan2021 @barda2021, by comparing fully vaccinated adults who did and did not receive a booster vaccine dose. We used the OpenSAFELY-TPP linked primary care database covering around 40% of English residents. Recruitment and follow-up covers an era where the Delta variant is dominant.

# Methods

## Data source

All data were linked, stored and analysed securely within the OpenSAFELY platform: <https://opensafely.org/>. Primary care records managed by the GP software provider TPP were linked, using NHS numbers, to A&E attendance and in-patient hospital spell records via NHS Digital's Hospital Episode Statistics (HES), national coronavirus testing records via the Second Generation Surveillance System (SGSS), and national death registry records from the Office for National Statistics (ONS). COVID-19 vaccination history is available in the GP record directly via the National Immunisation Management System (NIMS). Data include pseudonymized data such as coded diagnoses, medications and physiological parameters. No free text data are included.

## Eligibility criteria

We included adults aged $\geq$ 18 years who were eligible for booster vaccination between `r format(as.Date(study_dates$pfizerstart_date), "%e %B")` and `r format(as.Date(study_dates$pfizerend_date), "%e %B %Y")` inclusive (the "recruitment period"). On each day within this period, eligibility for the study was determined as follows: registered at a GP practice using TPP's SystmOne clinical information system; received a two-dose primary vaccination course of either BNT162b2 or ChAdOx1-S (mixed dosing and Moderna mRNA-1273 were not considered due to small numbers); not a health or social care worker, not resident in a care or nursing home; not medically housebound or receiving end-of-life care; no evidence of SARS-CoV-2 infection or COVID-19 disease within the previous 90 days; not undergoing an unplanned hospital admission; complete information on sex, ethnicity, deprivation, and NHS region.

 
Additionally, if the rolling weekly average count of BNT162b2 booster doses within strata defined by region, JCVI group, and the week of second dose was below 50 then recruitment did not occur for that stratum on that day. This helped ensure that recruitment was restricted to those boosted in line with national prioritisation schedules and that the matched controls were both eligible and able to receive a booster dose at the time of potential recruitment.

## Matching and treatment groups

On each day of the recruitment period, each eligible person receiving a booster dose was recruited to the treatment group and matched, if possible, with an eligible unboosted control person. Pairs were matched on: primary course vaccine brand; date of second vaccine dose, within 7 days; NHS region (East of England, Midlands, London, North East and Yorkshire, North West, South East, South West); evidence of prior SARS-CoV-2 infection (positive SARS-CoV-2 test, "probable" infection documented in primary care, or COVID-19 hospital admission); clinical risk groups used for prioritisation (clinically extremely vulnerable, clinically at-risk, neither); age, within 3 years; and age groups used by JCVI for prioritisation. 
<!-- The matching and exclusion criteria jointly ensure that treatment groups are also matched within JCVI priority group. -->

People selected as controls were not eligible to be included again as a control, but were eligible for subsequent inclusion in the booster group. Any unmatched boosted people were excluded. 

The supplementary materials provide further details of the matching process.
<!-- We excluded matched pairs from days in which fewer than 10% of eligible treated people were successfully. -->

## Outcomes

Four outcomes were considered: positive SARS-CoV-2 test; COVID-19 hospital admission; COVID-19 death; and non-COVID-19 death. SARS-CoV-2 infections were identified using SGSS testing records and based on swab date. Both polymerase chain reaction (PCR) and lateral flow test results are included, without differentiation between symptomatic and asymptomatic infection. COVID-19 hospital admissions were identified using HES in-patient hospital records with U07.1 or U07.2 reason for admission ICD-10 codes. Deaths were classified as from COVID-19 if deaths with the same ICD-10 codes were mentioned anywhere on the death certificate (i.e., as an underlying or contributing cause of death).

<!--# COVID-19 related A&E attendance and critical/intensive care admission we also considered but there were doubts over data the reliability of event ascertainment in these cases. -->

<!--# COVID-19 A&E attendances were identified using HES emergency care records with U07.1 ("COVID-19, virus identified") or U07.2 ("COVID-19, virus not identified") ICD-10 diagnosis codes @emergenc. -->

## Follow-up

Each person was followed from the day of recruitment (i.e., time zero) until the earliest of outcome, death, practice de-registration, booster receipt by the control in the matching pair, 10 weeks, or `r format(as.Date(study_dates$studyend_date), "%e %B %Y")`.

## Additional variables



The supplementary materials provide further details of the codelists and data sources used for all variables in the study.

## Statistical Analysis

We estimated Kaplan-Meier cumulative incidence curves separately in the boosted and unboosted groups, and the risk difference and risk ratio at `r label_number(accuracy=1)(max(postbaselinecuts)/7)` weeks. 

We used Cox models, stratified by recruitment day, NHS region, and brand of second vaccine dose, to estimate hazard ratios (HRs) comparing boosted with unboosted people, overall and separately for days 1-28 and 29-70. As we were not able to match on all potential confounders, these models included the following additional covariates: sex (male or female); English Index of Multiple Deprivation (IMD, grouped by quintile); ethnicity (Black, Mixed, South Asian, White, Other, as per the UK census); prior morbidity count (diabetes, BMI \> 40kg/m^2^, chronic heart disease, chronic kidney disease, chronic liver disease, chronic respiratory disease or severe asthma, chronic neurological disease); learning disabilities; severe mental illness; the number of SARS-CoV-2 tests in the 6 months prior to the study start date; elective in-hospital episode at the time of recruitment.A robust variance estimator was used to account for inclusion of some people in both the boosted and unboosted groups. Booster vaccine effectiveness was calculated as one minus the hazard ratio, expressed as a percentage.

<!-- [The primary estimand is the average treatment effect in the recruited population. To estimate this, expected cumulative incidence rates are estimated for each participant assuming treatment was received by everyone in both treatment groups at time zero. These curves are then averaged over all participants to give the marginal cumulative incidence. This is repeated assuming nobody is treated in either group, and their difference taken. Calculating standard errors for these quantities is challenging, whether approached analytically (due to complex variance components) or computationally (via bootstrapping, due to the large sample sizes involved) and are therefore not reported. ] -->

We also estimated booster effectiveness separately in the following subgroups: primary vaccine course; age (18-64 or $\geq$ 65 years); clinically extremely vulnerable or not. 



## Missing data

After exclusions for missing values on demographic variables, there were no missing values in the remaining variables as they were each defined by the presence or absence of clinical codes or events in the patient record. 

## Software, code, and reproducibility

Data management and analyses were conducted in Python version 3.8.10 and R version 4.0.2. All code is shared openly for review and re-sue under MIT open license at <https://github.com/opensafely/booster-effectiveness>. The supplementary materials provide further details of the codelists and data sources used for all variables in the study. Detailed pseudonymised patient data is potentially re-identifiable and therefore not shared. Any reported figures based on counts below 6 are redacted or rounded for disclosure control.

This study followed the STROBE-RECORD reporting guidelines.

## Patient and public involvement

We have developed a publicly available website <https://opensafely.org/> through which we invite any patient or member of the public to contact us regarding this study or the broader OpenSAFELY project.

# Results

## Study population and matching

`r label_number(1, big.mark=",")(filter(matchflowchart, crit=="c0", treatment=="pfizer") %>% pull(n))` adults registered at a TPP practice received a BNT162b2 booster vaccination during the recruitment period, with `r label_number(1, big.mark=",")(filter(matchflowchart, treatment=="pfizer", crit=="c7") %>% pull(n))` (`r label_percent(0.1)(filter(matchflowchart, treatment=="pfizer", crit=="c7") %>% pull(pct_all))`) eligible for inclusion in the treatment group, of whom `r label_number(1, big.mark=",")(filter(matchsummary, treatment=="pfizer") %>% pull(n_matched))` (`r label_percent(0.1)(filter(matchsummary, treatment=="pfizer") %>% pull(prop_matched_eligible))`) were matched with unboosted controls (Figure 1).

<!-- For mRNA-1273, this was `r label_number(1, big.mark=",")(filter(matchsummary, treatment=="moderna") %>% pull(n))` (`r label_percent(0.1)(filter(matchsummary, treatment=="moderna") %>% pull(prop_matched_eligible))`) and `r label_number(1, big.mark=",")(filter(matchsummary, treatment=="moderna") %>% pull(fup_years))` person-years of follow-up (Table 2).  -->

As expected, the matching factors has similar distributions in the boosted and unboosted groups at the start of follow up (Table 1), and the proportion of people with prior comorbidities was generally similar between the groups. However, unboosted controls had higher levels of deprivation, higher rates of learning disabilities and severe mental illness, and lower SARS-CoV-2 testing frequency, though the standardised mean difference was consistently below 0.1 (Supplementary Figure S2).



## Estimated booster effectiveness

### Main analysis

There were `r label_number(1, big.mark=",")(filter(incidences, treatment=="pfizer", outcome=="postest", fup_period=="All") %>% pull(events))` positive SARS-CoV-2 tests, 
`r label_number(1, big.mark=",")(filter(incidences, treatment=="pfizer", outcome=="covidadmitted", fup_period=="All") %>% pull(events))` COVID-19 hospital admissions, 
`r label_number(1, big.mark=",")(filter(incidences, treatment=="pfizer", outcome=="coviddeath", fup_period=="All") %>% pull(events))` COVID-19 deaths, 
and `r label_number(1, big.mark=",")(filter(incidences, treatment=="pfizer", outcome=="noncoviddeath", fup_period=="All") %>% pull(events))` non-COVID-19 deaths 
across `r label_number(1, big.mark=",")((filter(matchsummary, treatment=="pfizer") %>% pull(fup_years)) *365.25/7)` person-weeks of follow-up. 
The 10-week risk of positive SARS-CoV-2 test was `r km70 %>% filter(treatment=="pfizer", outcome=="postest", subgroup=="none") %>% pull(risk_1) %>% (label_number(0.1, scale=1000))` per 1000 in the boosted group 
and `r km70 %>% filter(treatment=="pfizer", outcome=="postest", subgroup=="none") %>% pull(risk_0) %>% (label_number(0.1, scale=1000))` in the unboosted group, 
representing a risk difference of `r km70 %>% filter(treatment=="pfizer", outcome=="postest", subgroup=="none") %>% pull(kmrd) %>% (label_number(0.1, scale=1000))` per 1000. 
For COVID-19 hospital admission, this was `r km70 %>% filter(treatment=="pfizer", outcome=="covidadmitted", subgroup=="none") %>% pull(risk_1) %>% (label_number(0.1, scale=1000))` 
and `r km70 %>% filter(treatment=="pfizer", outcome=="covidadmitted", subgroup=="none") %>% pull(risk_0) %>% (label_number(0.1, scale=1000))` 
respectively (`r km70 %>% filter(treatment=="pfizer", outcome=="covidadmitted", subgroup=="none") %>% pull(kmrd) %>% (label_number(0.1, scale=-1000))` fewer events). 
For COVID-19 death it was `r km70 %>% filter(treatment=="pfizer", outcome=="coviddeath", subgroup=="none") %>% pull(risk_1) %>% (label_number(0.1, scale=1000))` 
and `r km70 %>% filter(treatment=="pfizer", outcome=="coviddeath", subgroup=="none") %>% pull(risk_0) %>% (label_number(0.1, scale=1000))` 
(`r km70 %>% filter(treatment=="pfizer", outcome=="coviddeath", subgroup=="none") %>% pull(kmrd) %>% (label_number(0.1, scale=-1000))` fewer events), 
and for non-COVID-19 death it was `r km70 %>% filter(treatment=="pfizer", outcome=="noncoviddeath", subgroup=="none") %>% pull(risk_1) %>% (label_number(0.1, scale=1000))` 
and `r km70 %>% filter(treatment=="pfizer", outcome=="noncoviddeath", subgroup=="none") %>% pull(risk_0) %>% (label_number(0.1, scale=1000))` 
(`r km70 %>% filter(treatment=="pfizer", outcome=="noncoviddeath", subgroup=="none") %>% pull(kmrd) %>% (label_number(0.1, scale=-1000))` fewer events) respectively  (Table 2).

The rate of increase in the cumulative incidence of positive SARS-CoV-2 tests in boosted people tapered substantially around 7 days after boosting, something not observed in unboosted controls (Figure 2). The cumulative incidence of COVID-19 hospital admission and COVID-19 death also diverged substantially between the boosted and unboosted groups. We also see substantial differences for non-COVID-19 deaths between the boosted and unboosted.

The overall (days 1-70) estimated booster effectiveness (95% CI) comparing the boosted and unboosted gorups was `r filter(overallhazards, subgroup=="none", outcome=="postest", treatment=="pfizer", model==3) %>% pull(ve_display95)` for positive SARS-CoV-2 test, `r filter(overallhazards, subgroup=="none", outcome=="covidadmitted", treatment=="pfizer", model==3) %>% pull(ve_display)` for COVID-19 hospital admission, `r filter(overallhazards, subgroup=="none", outcome=="coviddeath", treatment=="pfizer", model==3) %>% pull(ve_display)` for COVID-19 death, and `r filter(overallhazards, subgroup=="none", outcome=="noncoviddeath", treatment=="pfizer", model==3) %>% pull(ve_display)` for non-COVID-19 death. Estimated booster effectiveness against COVID-19 outcomes was generally lower during days 1-28 than days 29-70: `r filter(meta2hazards, subgroup=="none", outcome=="postest", treatment=="pfizer", model==3, term_right==28) %>% pull(ve_display)` and `r filter(meta2hazards, subgroup=="none", outcome=="postest", treatment=="pfizer", model==3, term_right==70) %>% pull(ve_display)` for positive SARS-CoV-2 test; `r filter(meta2hazards, subgroup=="none", outcome=="covidadmitted", treatment=="pfizer", model==3, term_right==28) %>% pull(ve_display)` and `r filter(meta2hazards, subgroup=="none", outcome=="covidadmitted", treatment=="pfizer", model==3, term_right==70) %>% pull(ve_display)` respectively for COVID-19 hospital admission; `r filter(meta2hazards, subgroup=="none", outcome=="coviddeath", treatment=="pfizer", model==3, term_right==28) %>% pull(ve_display)` and `r filter(meta2hazards, subgroup=="none", outcome=="coviddeath", treatment=="pfizer", model==3, term_right==70) %>% pull(ve_display)` respectively for COVID-19 death. Estimated booster effectiveness against non-COVID19 death was similar during days 1-28 and 29-70 (`r filter(meta2hazards, subgroup=="none", outcome=="noncoviddeath", treatment=="pfizer", model==3, term_right==28) %>% pull(ve_display)` and `r filter(meta2hazards, subgroup=="none", outcome=="noncoviddeath", treatment=="pfizer", model==3, term_right==70) %>% pull(ve_display)`).

Estimated effectiveness for narrower time periods are provided in supplementary materials (Table S3).

### Subgroup analyses

Estimated booster effectiveness was similar between subgroups defined by primary vaccine course. For those who had received BNT162b2, estimated booster effectiveness was `r filter(overallhazards, outcome=="postest", treatment=="pfizer", subgroup_level=="pfizer-pfizer", model==3) %>% pull(ve_display)` for positive SARS-CoV-2 test, `r filter(overallhazards, outcome=="covidadmitted", treatment=="pfizer", subgroup_level=="pfizer-pfizer", model==3) %>% pull(ve_display)` for COVID-19 hospital admission, `r filter(overallhazards, outcome=="coviddeath", treatment=="pfizer", subgroup_level=="pfizer-pfizer", model==3) %>% pull(ve_display)` for COVID-19 death, and `r filter(overallhazards, outcome=="noncoviddeath", treatment=="pfizer", subgroup_level=="pfizer-pfizer", model==3) %>% pull(ve_display)` for non-COVID-19 death. Corresponding estimates of booster effectiveness for ChAdOx1-S recipients were `r filter(overallhazards, outcome=="postest", treatment=="pfizer", subgroup_level=="az-az", model==3) %>% pull(ve_display)`, `r filter(overallhazards, outcome=="covidadmitted", treatment=="pfizer", subgroup_level=="az-az", model==3) %>% pull(ve_display)`, `r filter(overallhazards, outcome=="coviddeath", treatment=="pfizer", subgroup_level=="az-az", model==3) %>% pull(ve_display)`, and `r filter(overallhazards, outcome=="noncoviddeath", treatment=="pfizer", subgroup_level=="az-az", model==3) %>% pull(ve_display)` respectively.

Amongst people classified as clinically extremely vulnerable estimated booster effectiveness was `r filter(overallhazards, outcome=="postest", treatment=="pfizer", subgroup=="cev-TRUE", model==3) %>% pull(ve_display)` for positive SARS-CoV-2 test, `r filter(overallhazards, outcome=="covidadmitted", treatment=="pfizer", subgroup=="cev-TRUE", model==3) %>% pull(ve_display)` for COVID-19 hospital admission, and `r filter(overallhazards, outcome=="coviddeath", treatment=="pfizer", subgroup=="cev-TRUE", model==3) %>% pull(ve_display)` for COVID-19 death. For people who not classified as clinically extremely vulnerable estimated booster effectiveness was slightly higher, at `r filter(overallhazards, outcome=="postest", treatment=="pfizer", subgroup=="cev-FALSE", model==3) %>% pull(ve_display)`, `r filter(overallhazards, outcome=="covidadmitted", treatment=="pfizer", subgroup=="cev-FALSE", model==3) %>% pull(ve_display)`, and `r filter(overallhazards, outcome=="coviddeath", treatment=="pfizer", subgroup=="cev-FALSE", model==3) %>% pull(ve_display)`, respectively. Estimated booster effectiveness for non-COVID-19 death was similar for those who were and were not classified as clinically extremely vulnerable: `r filter(overallhazards, outcome=="noncoviddeath", treatment=="pfizer", subgroup=="cev-TRUE", model==3) %>% pull(ve_display)` and `r filter(overallhazards, outcome=="noncoviddeath", treatment=="pfizer", subgroup=="cev-FALSE", model==3) %>% pull(ve_display)` respectively.

Amongst people aged $\geq$ 65 years estimated booster effectiveness was `r filter(overallhazards, outcome=="postest", treatment=="pfizer", subgroup=="age65plus-TRUE", model==3) %>% pull(ve_display)` for positive SARS-CoV-2 test, `r filter(overallhazards, outcome=="covidadmitted", treatment=="pfizer", subgroup=="age65plus-TRUE", model==3) %>% pull(ve_display)` for COVID-19 hospital admission, `r filter(overallhazards, outcome=="coviddeath", treatment=="pfizer", subgroup=="age65plus-TRUE", model==3) %>% pull(ve_display)` for COVID-19 death, and `r filter(overallhazards, outcome=="noncoviddeath", treatment=="pfizer", subgroup=="age65plus-TRUE", model==3) %>% pull(ve_display)` for non-COVID-19 death.  Corresponding effectiveness was slightly lower in people aged 18-64 years: `r filter(overallhazards, outcome=="postest", treatment=="pfizer", subgroup=="age65plus-FALSE", model==3) %>% pull(ve_display)`, `r filter(overallhazards, outcome=="covidadmitted", treatment=="pfizer", subgroup=="age65plus-FALSE", model==3) %>% pull(ve_display)`, `r filter(overallhazards, outcome=="coviddeath", treatment=="pfizer", subgroup=="age65plus-FALSE", model==3) %>% pull(ve_display)`, and `r filter(overallhazards, outcome=="noncoviddeath", treatment=="pfizer", subgroup=="age65plus-FALSE", model==3) %>% pull(ve_display)` respectively.



# Discussion

This observational study investigated the effectiveness of a BNT162b2 booster dose in `r label_number(1, big.mark=",")(filter(matchsummary, treatment=="pfizer") %>% pull(n_matched))` adults, and their matched controls, in England in the Delta era. We found high protection against all studied outcomes. There were apparent waning protection against positive SARS-CoV-2 tests around 6 weeks after boosting, which is unlikely to be explained by increased transmissibility of the Omicron variant given Omicron was not yet dominant in the UK by the end of the follow-up window @COVID19OmicronDaily. Changing testing behaviours over time between boosted and unboosted people may influence these estimates, if for example persistently unboosted participants, who will contribute more person-time in later follow-up periods, were less likely to get tested.

Protection was similar between 2× BNT162b2 primary course recipients and 2× ChAdOx1-S recipients, except for COVID-19 death in the first 28 days where protected appeared higher for those whose primary course was 2× BNT162b2 than for 2× ChAdOx1-S. For severe outcomes, protection was lower in the clinical extremely vulnerable sub-population than in those who were not vulnerable.

We considered effectiveness in a population where Delta was the predominant circulating variant @COVID19OmicronDaily. Re-running the analysis against a backdrop of the now globally-dominant Omicron variant will be undertaken where valid concurrent comparisons between boosted and unboosted people can be made. Further, mRNA-1273 boosting began later than for BNT162b2 so we did not evaluate effectiveness of this vaccine due to insufficient follow-up. An analysis of mRNA-1273 boosting and comparative effectiveness between mRNA-1273 and BNT162b2 is planned.

### Strengths and Limitations

We used routinely-collected health records with comprehensive coverage of primary care, hospital admissions, COVID-19 testing and vaccination, and death registrations. This provides substantial power to estimate effectiveness of booster doses against severe but rare outcomes such as hospital admission and death, including period-specific effects to investigate waning protection.

We carefully matched booster recipients with unboosted controls using characteristics known at baseline to strengthen exchangeability between treatment groups and reduce dependence on modelling assumptions in the estimates of effectiveness. However, despite reasonable balance of important baseline characteristics and additional adjustment for a range of potential confounders, the possibility of unmeasured confounding remains. In particular, the apparent protective effect immediately after boosting is biologically implausible, and will be explained in part by the occurrence at baseline of COVID-19 symptoms in the unboosted controls that were not recorded in the health record, and so could not be identified and excluded. Such symptoms are much less likely in booster recipients as symptomatic people, or those with a recent positive test, were ineligible for boosting.

The matching approach is robust but inefficient; a minority of boosted individuals are not retained after matching, and those who are retained are censored when their matched control is boosted, reducing the follow-up duration and therefore statistical power. Millions of eligible participants may be required to obtain precise estimates, particularly when event rates are low, and so extending the approach to smaller subgroups may not be feasible. For instance, due to small numbers, we did not study booster effectiveness in those who had received the mRNA-1273 vaccine as their primary course or those who had received a heterologous primary course, despite many thousands of such recipients in England.

Positive SARS-CoV-2 test data likely underestimates the true incidence of infection. The mass availability of lateral flow tests in the UK during the study period, whose results are not routinely recorded in COVID-19 surveillance data, means many infections, including symptomatic infections, may be undocumented, despite encouragement to seek a confirmatory PCR test. Potential differences in testing behaviour between boosted and unboosted people also contributes to the unreliability of testing data as a means to assess effectiveness @glasziou2022. SARS-CoV-2 testing was not widely available early in the pandemic so evidence of prior infection is likely to be under-ascertained. We may not have all records of negative tests so counts of number of tests are also incomplete. Hospital admission records are only completed after discharge, so some very long hospital stays commencing within the follow-up period may not have been included.

We excluded a number of groups, such as health care workers and care home residents, where testing use, vaccination uptake, and infection risk were unusual or had substantial within-group heterogeneity that could not adequately measured and controlled for. The generalisability of our results to these excluded groups is unclear.

### Findings in context

<!-- [ cov-boost trial] -->

A phase III trial assessing BNT162b2 booster efficacy in two-dose BNT162b2 recipients without prior infection reported a relative efficacy of 95.6% (95% CI 89.3-98.6) against Delta infection @PfizerBioNTechAnnounce2021. Observational studies in the UK have provided evidence for increased protection from the booster vaccine against symptomatic COVID-19 infection in comparison to second dose recipients using a test negative design. Andrews et al. reported estimates of relative vaccine effectiveness against symptomatic disease in the 14 days after a BNT162b2 booster dose in those aged over 50 years of 87.4% (95%CI 84.9-89.4) where the primary course was ChAdOx1-S and 84.4% (95%CI 82.8-85.8) for BNT162b2 @andrews2021. A study in Scotland reported comparable estimates of relative vaccine effectiveness for S gene positive symptomatic infection (83% (95%CI 81-84) 6-49 years, 88% (95%CI 86-89) over 50 years) in the 14 days after a BNT162b2 or mRNA-1273 booster dose, but lower estimates for S gene negative symptomatic infection (56% (95%CI 51-60) 6-49 years, 57% (95%CI 52-62) over 50 years) @sheikhSeverityOmicronVariant2021. Elsewhere, a study in Israeli health registry data found strong protection against admission (1 -- risk ratio (95%CI) = 93% (88-97)), severe disease (92% (82-97)), and COVID-19 death (81% (59-97)), with similar results in specific demographic and clinical subgroups @barda2021. 

Our results broadly agree with these findings and provide important additional insights into effectiveness in specific clinical subgroups, younger age groups, and more severe outcomes over a longer period of follow up. Encouragingly, we found effectiveness was broadly similar irrespective of whether BNT162b2 or ChAdOx1-S was given for the primary vaccination course, and the were only slight reductions in effectiveness in those who were clinically extremely vulnerable. 


<!-- @1050236/technical-briefing-34-14-january-2022.pdf -->

### Conclusion

This study of over 8 million people in England found high protection for BNT162b2 boosting against positive SARS-CoV-2 tests, COVID-19 hospital admission, and death during a period in which the Delta variant was dominant.

\newpage

## Acknowledgements

We are very grateful for all the support received from the TPP Technical Operations team throughout this work, and for generous assistance from the information governance and database teams at NHS England / NHSX.

Our thanks to Susana Monge-Corella for helpful discussions on optimising the matching algorithm.

## Conflicts of Interest

All authors have completed the ICMJE uniform disclosure form and declare the following: BG has received research funding from Health Data Research UK (HDRUK), the Laura and John Arnold Foundation, the Wellcome Trust, the NIHR Oxford Biomedical Research Centre, the NHS National Institute for Health Research School of Primary Care Research, the Mohn-Westlake Foundation, the Good Thinking Foundation, the Health Foundation, and the World Health Organisation; he also receives personal income from speaking and writing for lay audiences on the misuse of science. IJD holds shares in GlaxoSmithKline (GSK).

## Funding

This work was supported by the UKRI Medical Research Council MR/V015737/1 and the Longitudinal Health and Wellbeing COVID-19 National Core Study (UKRI MRC MC_PC_20030 and MC_PC_20059). Data assets were supported by the Data and Connectivity National Core Study, led by Health Data Research UK in partnership with the Office for National Statistics and funded by UKRI (MC_PC_20029 and MC_PC_20058). The OpenSAFELY platform is funded by the Wellcome Trust. TPP provided technical expertise and infrastructure within their data centre pro bono in the context of a national emergency. BGs work on clinical informatics is supported by the NIHR Oxford Biomedical Research Centre and the NIHR Applied Research Collaboration Oxford and Thames Valley. BG's work on better use of data in healthcare more broadly is currently funded in part by: NIHR Oxford Biomedical Research Centre, NIHR Applied Research Collaboration Oxford and Thames Valley, the Mohn-Westlake Foundation, NHS England, and the Health Foundation; all DataLab staff are supported by BG's grants on this work. LS reports grants from Wellcome, MRC, NIHR, UKRI, British Council, GSK, British Heart Foundation, and Diabetes UK outside this work. KB holds a Wellcome Senior Research Fellowship (220283/Z/20/Z). HIM is funded by the NIHR Health Protection Research Unit in Immunisation, a partnership between Public Health England and London School of Hygiene & Tropical Medicine. AYSW holds a fellowship from the British Heart Foundation. EJW holds grants from MRC. RM holds a Sir Henry Wellcome Fellowship funded by the Wellcome Trust (201375/Z/16/Z). HF holds a UKRI fellowship. IJD holds grants from NIHR and GSK. JACS is funded by the NIHR Bristol Biomedical Research Centre and by Health Data Research UK.

Funders had no role in the study design, collection, analysis, and interpretation of data; in the writing of the report and in the decision to submit the article for publication.

The views expressed are those of the authors and not necessarily those of the NIHR, NHS England, Public Health England or the Department of Health and Social Care.

For the purpose of Open Access, the author has applied a CC BY public copyright licence to any Author Accepted Manuscript (AAM) version arising from this submission.

## Information governance and ethical approval

NHS England is the data controller for OpenSAFELY-TPP; TPP is the data processor; and study authors using OpenSAFELY have the approval of NHS England. This implementation of OpenSAFELY is hosted within the TPP environment which is accredited to the ISO 27001 information security standard and is NHS IG Toolkit compliant @betad @datasec ; Patient data has been pseudonymised for analysis and linkage using industry standard cryptographic hashing techniques; all pseudonymised datasets transmitted for linkage onto OpenSAFELY are encrypted; access to the platform is via a virtual private network (VPN) connection, restricted to a small group of researchers; the researchers hold contracts with NHS England and only access the platform to initiate database queries and statistical models; all database activity is logged; only aggregate statistical outputs leave the platform environment following best practice for anonymisation of results such as statistical disclosure control for low cell counts @isb1523 . The OpenSAFELY research platform adheres to the obligations of the UK General Data Protection Regulation (GDPR) and the Data Protection Act 2018. In March 2020, the Secretary of State for Health and Social Care used powers under the UK Health Service (Control of Patient Information) Regulations 2002 (COPI) to require organisations to process confidential patient information for the purposes of protecting public health, providing healthcare services to the public and monitoring and managing the COVID-19 outbreak and incidents of exposure; this sets aside the requirement for patient consent @coronavi2020 . Taken together, these provide the legal bases to link patient datasets on the OpenSAFELY platform. General practices, from which the primary care data are obtained, are required to share relevant health information to support the public health response to the pandemic, and have been informed of the OpenSAFELY analytics platform.

This study was approved by the Health Research Authority (REC reference 20/LO/0651) and by the LSHTM Ethics Board (reference 21863).

BG is guarantor.

\newpage

## Tables and Figures

#### Table 1: Participant characteristics

Participant characteristics as on the day of recruitment into the treatment or control group.

```{r table-table1, echo=FALSE, warning=FALSE, message=FALSE}
table1_body <- read_csv(fs::path(output_dir_os, "matchtable1.csv")) %>% filter(treatment=="pfizer")
table1_by <- read_csv(fs::path(output_dir_os, "matchtable1by.csv")) %>% filter(treatment=="pfizer")

table1 <- 
  table1_body %>%
  #filter(outcome %in% outcomes) %>%
  group_by(variable) %>%
  mutate(
    label = if_else(row_number()==1, label, str_c("&nbsp;&nbsp;&nbsp;", label)),
  ) %>%
  mutate(
    across(
      starts_with("stat_"),
      ~if_else(is.na(.x) & row_number()==1, "", .x)
    )
  ) %>%
  ungroup() %>%
  mutate(
    order = cumsum(lag(variable, 1, first(variable))!=variable)
  ) %>%
  select(
    variable, var_label, label, starts_with("stat_"), order
  ) %>%
  rename(!!!set_names(table1_by$by_col, table1_by$by_chr))


table1 %>%
  select(-`Boosted, ineligible`, -`Boosted, eligible, unmatched`) %>%
  gt(groupname_col="treatment_descr") %>%
  fmt_markdown(columns = "label") %>%
  tab_style(
    style = list(
      cell_fill(color = "gray96")
    ),
    locations = cells_body(
      rows = order%%2 == 0
    )
  ) %>%
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = cells_column_labels(everything())
  ) %>%
  cols_label(
     label=md("Characteristic")
  ) %>%
  cols_hide(c("variable", "var_label", "order"))
```


\newpage

#### Table 2: Follow-up and outcomes

Total follow-up and incidence rates for each outcome, by treatment group. The cumulative incidence of each outcome is provided in Figure 2.

```{r table-incidence, echo=FALSE, warning=FALSE, message=FALSE}

incidences %>%
  left_join(km70) %>%
  filter(
    fup_period == "All",
    outcome %in% outcomes,
    treatment == "pfizer"
  ) %>%
  select(
    #treatment_descr, 
    outcome_descr,
    #fup_period,
    q_1,
    risk_1,
    q_0, 
    risk_0,
    kmrrE,
    kmrdE
    #rrECI
  ) %>%
  mutate(
    risk_1=if_else(risk_1<0.001, "<0.001", label_number(0.001)(risk_1)),
    risk_0=if_else(risk_0<0.001, "<0.001", label_number(0.001)(risk_0)),
  ) %>%
  gt(
   #groupname_col = c("treatment_descr"),
  ) %>%
  cols_label(
    #treatment_descr = "Treatment",
    outcome_descr = "Outcome",
    #fup_period = "Days since booster",
    q_0 = "Events / person-years",
    q_1   = "Events / person-years",
    
    #rate_0 = "Incidence rate",
    #rate_1 = "Incidence rate",
    
    risk_0 = "Cumulative risk",
    risk_1 = "Cumulative risk",
    kmrrE = "Risk ratio",
    kmrdE = "Risk difference (per 1000 people)"
    #rrECI = "Incidence rate ratio (95% CI)"
  ) %>%
  tab_spanner(
    label = "Boosted",
    columns = ends_with("1")
  ) %>%
  tab_spanner(
    label = "Unboosted",
    columns = ends_with("0")
  ) %>%
  fmt_missing(
    everything(),
    missing_text="--"
  ) %>%
  cols_align(
    align = "right",
    columns = everything()
  ) 


```


\newpage

#### Table 3: Estimated booster effectiveness

Vaccine effectiveness, $(1-\text{hazard ratio})\times100\%$, for the main and subgroup analyses across all outcomes.

```{r table-effects, echo=FALSE, message=FALSE, warning=FALSE, out.extra='', fig.height=7.5, out.width='90%', results='asis'}

bind_rows(
  meta2hazards,
  overallhazards %>% mutate(term_left = 0, term_right=70)
) %>%
  filter(model==3, treatment=="pfizer") %>%
  mutate(
    period = fct_inorder(paste(term_left+1, "-", term_right)),
    ve_display = str_remove(ve_display, fixed("%"))
  ) %>%
  arrange(treatment_descr, outcome_descr, subgroup_level_descr, period) %>%
  group_by(outcome, treatment, subgroup_level_descr, model) %>%
  mutate(
    #subgroup_level_descr=if_else(row_number()==1, subgroup_level_descr, factor(NA, levels=levels(subgroup_level_descr))),
    period = paste0(period, " days")
  ) %>%
  ungroup() %>%
  select(outcome_descr, subgroup_level_descr, period, ve_display) %>%
  pivot_wider(
    id_cols = c("outcome_descr", "subgroup_level_descr"),
    names_from = "period",
    #names_prefix ="period",
    values_from = "ve_display"
  ) %>%
  gt(
    groupname_col = c("outcome_descr"),
  ) %>%
  cols_label(
    #treatment_descr = "Treatment",
    subgroup_level_descr="",
    outcome_descr = "Outcome",

    #hr_display   = "HR (95% CI)",
    #ve_display   = "VE (95% CI)",
  ) %>%
  cols_align(
    align = "right",
    columns = everything()
  ) %>%
  tab_spanner(
    label = "Booster vaccine effectiveness (95% CI)",
    columns = ends_with("days")
  ) %>%
  fmt_missing(
    c("subgroup_level_descr"),
    missing_text=""
  )

```

\newpage

#### Figure 1: Inclusion criteria

(need to convert to figure)

```{r figure-flowchart, echo=FALSE, warning=FALSE, message=FALSE}

matchflowchart %>%
  transmute(
    treatment,
    stage,
    criteria = str_wrap(criteria, 40),
    n,
    n_exclude,
    pct_all
  ) %>%
  pivot_wider(
    id_cols = c(stage, criteria),
    names_from = treatment,
    values_from = c(n, n_exclude, pct_all)
  ) %>%
  gt() %>%
  cols_label(
    stage="",
    criteria = "",
    
    n_pfizer = "N",
    #n_moderna = "N",

    n_exclude_pfizer = "N excluded",
    #n_exclude_moderna = "N excluded",
    
    pct_all_pfizer = "% remaining",
    #pct_all_moderna = "% remaining",
  ) %>%
  tab_spanner(
    label = "BNT162b2",
    columns = ends_with("pfizer")
  ) %>%
  # tab_spanner(
  #   label = "mRNA-1273",
  #   columns = ends_with("moderna")
  # ) %>%
  fmt_percent(
    columns = starts_with(c("pct_")),
    decimals = 1
  ) %>%
  fmt_number(
    columns = starts_with(c("n_")),
    decimals= 0
  ) %>%
  fmt_missing(
    everything(),
    missing_text="-"
  ) %>%
  tab_style(
    style=cell_text(whitespace ="pre-wrap"),
    #style=cell_text(style ="italic"),
    locations = cells_body(columns = "criteria")
  )
```


\newpage

#### Figure 2: Cumulative outcome incidence

Kaplan-Meier estimates of cumulative incidence in matched boosted and unboosted treatment groups, stratified by primary course and without further adjustment for potential confounders.

```{r figure-cmlinc, echo=FALSE, message=FALSE, warning=FALSE, out.extra='', out.width='90%', fig.height=7.5, results='asis'}

plot_km <- 
  km %>%
  filter(
    outcome %in% outcomes,
    treatment=="pfizer",
    subgroup_variable %in% c("none", "vax12_type")
  ) %>%
    ggplot()+
    geom_step(aes(x=time, y=(1-surv)*1000, group=treated_descr, colour=treated_descr))+
    geom_rect(aes(xmin=time, xmax=leadtime, ymin=(1-surv.ll)*1000, ymax=(1-surv.ul)*1000, group=treated_descr, fill=treated_descr), alpha=0.1)+
    geom_hline(aes(yintercept=0), colour='black')+
    facet_grid(rows=vars(outcome_descr_wrap), cols=vars(subgroup_level_descr), switch="y", scales="free_y")+
    scale_x_continuous(
      breaks = seq(0,7*max(postbaselinecuts),by=14),
      expand = expansion(0)
    )+
    scale_y_continuous(
      expand = expansion(0),
      #limits = c(0L,NA)
    )+
    scale_colour_brewer(type="qual", palette="Set1", na.value="grey")+
    scale_fill_brewer(type="qual", palette="Set1", guide="none", na.value="grey")+
    labs(
      x=NULL,
      y="Cumulative incidence\nper 1000",
      colour=NULL
    )+
    theme_minimal()+
    theme(
      legend.position = "bottom",
      legend.direction = "horizontal",
      #legend.position=c(0.01,0.85),
      #legend.justification = c(0,0),
      #legend.direction = "vertical",
      axis.text.x.top=element_text(hjust=0),

      strip.placement = "outside",
      strip.background = element_blank(),
      strip.text.y.left = element_text(angle = 0),

      panel.border = element_blank(),
      axis.line.y = element_line(colour = "black"),
      axis.line.x.top = element_line(colour = "black"),
      panel.grid.minor.x = element_blank(),
      panel.grid.minor.y = element_blank(),

      panel.spacing = unit(0.8, "lines"),

    )+
    NULL


  ggsave(
    filename="plot_km.svg",
    path=output_dir_rmd,
    plot=plot_km,
  )
  
plot_km

```


\newpage

#### Figure 3: Estimated booster effectiveness

For each outcome based on the fully adjusted model, the hazard ratios for boosting with BNT162b2 versus not boosting is shown, stratified by primary course and time since boosting. Models with less extensive confounder adjustment are provided in supplementary materials (Figure S3).

```{r figure-effects, echo=FALSE, message=FALSE, warning=FALSE, out.extra='', fig.height=7.5, out.width='90%', results='asis'}

formatpercent100 <- function(x,accuracy){
  formatx <- scales::label_percent(accuracy, suffix="")(x)

  if_else(
    formatx==scales::label_percent(accuracy, suffix="")(1),
    paste0(">",scales::label_percent(1, suffix="")((100-accuracy)/100)),
    formatx
  )
}

  ## hazard ratio

  y_breaks <- c(0.01, 0.02, 0.05, 0.1, 0.2, 0.5, 1, 2)

  
  overallhazards_plotdata <- 
    overallhazards %>%
    filter(
      model==3, 
      outcome %in% outcomes,
      treatment %in% c("pfizer"),
      subgroup_variable %in% c("none", "vax12_type")
    )
  
  postbaselinecuts28 <- c(0,28,70)
  
  plot_hazards <-
    meta2hazards %>%
    filter(
      model==3,
      outcome %in% outcomes,
      treatment %in% c("pfizer"),
      subgroup_variable %in% c("none", "vax12_type")
    ) %>%
    ggplot()+
    geom_point(aes(y=hr, x=term_midpoint, colour=model_descr), position = position_dodge(width = 1.8))+
    geom_linerange(aes(ymin=hr.ll, ymax=hr.ul, x=term_midpoint, colour=model_descr), position = position_dodge(width = 1.8))+
    geom_point(data = overallhazards_plotdata, mapping = aes(y=hr, x=max(postbaselinecuts28+14)), colour="darkgrey") +
    geom_linerange(data = overallhazards_plotdata, mapping = aes(ymin=hr.ll, ymax=hr.ul, x=max(postbaselinecuts28+14)), colour="darkgrey") +
    geom_rect(data = overallhazards_plotdata, ymin=-Inf, ymax=Inf, xmin=max(postbaselinecuts28), xmax=max(postbaselinecuts28+28), fill="grey95", alpha=0.5, colour="transparent") +
    geom_hline(aes(yintercept=1), colour='grey')+
    facet_grid(rows=vars(outcome_descr_wrap), cols=vars(subgroup_level_descr), switch="y")+
    # scale_y_log10(
    #   breaks=y_breaks,
    #   limits = c(0.03, 1.5),
    #   oob = scales::oob_keep,
    #   sec.axis = sec_axis(
    #     ~(1-.),
    #     name="Effectiveness (%)",
    #     breaks = 1-(y_breaks),
    #     labels = function(x){formatpercent100(x, 1)}
    #   )
    # )+
    scale_y_reverse(
      limits = c(1.1, 0),
      breaks = c(1, 0.75, 0.50, 0.25, 0),
      #expand = expansion(c(NA, 0)),
      oob = scales::oob_keep,
      sec.axis = sec_axis(
        ~(1-.),
        name="Effectiveness (%)",
        labels= scales::label_percent(1, suffix="")
      )
    )+
    scale_x_continuous(breaks=c(postbaselinecuts28, max(postbaselinecuts28+14)), labels=c(postbaselinecuts28, "All"), limits=c(min(postbaselinecuts28), max(postbaselinecuts28+14)+14), expand = c(0, 0))+
    scale_colour_brewer(type="qual", palette="Set2", guide=guide_legend(ncol=1))+
    labs(
      y="Hazard ratio",
      x="Days since booster dose",
      colour=NULL
     ) +
    theme_minimal()+
    theme(
      panel.border = element_blank(),
      axis.line.y = element_line(colour = "black"),
      axis.line.y.right = element_blank(),
  
      panel.grid.minor.x = element_blank(),
      panel.grid.minor.y = element_blank(),
      strip.background = element_blank(),
      strip.placement = "outside",
      strip.text.y.left = element_text(angle = 0),
  
      panel.spacing = unit(0.8, "lines"),
  
      plot.title = element_text(hjust = 0),
      plot.title.position = "plot",
      plot.caption.position = "plot",
      plot.caption = element_text(hjust = 0, face= "italic"),
  
      legend.position = "none"
     ) +
    NULL
  
  ggsave(
    filename="plot_hazards.svg",
    path=output_dir_rmd,
    plot=plot_hazards,
  )
  
  plot_hazards
  
```


\newpage

## References
