version: '3.0'

expectations:

  population_size: 100000

actions:

  ## # # # # # # # # # # # # # # # # # # # 
  ## DO NOT EDIT project.yaml DIRECTLY 
  ## This file is created by create-project.R 
  ## Edit and run create-project.R to update the project.yaml 
  ## # # # # # # # # # # # # # # # # # # # 
  ## # # # # # # # # # # # # # # # # # # # 
  ## Pre-server scripts 
  ## # # # # # # # # # # # # # # # # # # # 
  ## # # # # # # # # # # # # # # # # # # # 
  ## Extract and tidy 
  ## # # # # # # # # # # # # # # # # # # # 

  extract:
    run: cohortextractor:latest generate_cohort --study-definition study_definition
      --output-format feather
    needs: []
    outputs:
      highly_sensitive:
        cohort: output/input.feather

  extract_report:
    run: cohort-report:v3.0.0 output/input.feather
    needs:
    - extract
    outputs:
      moderately_sensitive:
        html: output/data/reports/extract/*.html
        png: output/data/reports/extract/*.png
    config:
      output_path: output/data/reports/extract/

  data_process:
    run: r:latest analysis/data_process.R
    needs:
    - extract
    outputs:
      highly_sensitive:
        rds: output/data/data_processed.rds
        vaxlong: output/data/data_vaxlong.rds

  data_process_long:
    run: r:latest analysis/data_process_long.R
    needs:
    - data_process
    outputs:
      highly_sensitive:
        processed: output/data/data_long*.rds

  data_selection:
    run: r:latest analysis/data_selection.R
    needs:
    - data_process
    outputs:
      highly_sensitive:
        data: output/data/data_cohort.rds
        feather: output/data/data_cohort.feather
      moderately_sensitive:
        flow: output/data/flowchart.csv

  cohort_report:
    run: cohort-report:v3.0.0 output/data/data_cohort.feather
    needs:
    - data_selection
    outputs:
      moderately_sensitive:
        html: output/data/reports/cohort/*.html
        png: output/data/reports/cohort/*.png
    config:
      output_path: output/data/reports/cohort/

  ## # # # # # # # # # # # # # # # # # # # 
  ## Descriptive stats 
  ## # # # # # # # # # # # # # # # # # # # 

  descriptive_table1:
    run: r:latest analysis/table1.R
    needs:
    - data_selection
    outputs:
      moderately_sensitive:
        html: output/descriptive/table1/*.html
        csv: output/descriptive/table1/*.csv

  descriptive_vaxdate:
    run: r:latest analysis/vax_date.R
    needs:
    - data_selection
    outputs:
      moderately_sensitive:
        png: output/descriptive/vaxdate/*.png
        pdf: output/descriptive/vaxdate/*.pdf
        svg: output/descriptive/vaxdate/*.svg

  ## # # # # # # # # # # # # # # # # # # # 
  ## Matching 
  ## # # # # # # # # # # # # # # # # # # # 

  match_seqtrialcox_pfizer:
    run: r:latest analysis/match_seqtrialcox.R pfizer
    needs:
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/models/seqtrialcox/pfizer/match_*.rds
      moderately_sensitive:
        txt: output/models/seqtrialcox/pfizer/match_*.txt
        csv: output/models/seqtrialcox/pfizer/match_*.csv
        png: output/models/seqtrialcox/pfizer/match_*.png
        pdf: output/models/seqtrialcox/pfizer/match_*.pdf

  merge_seqtrialcox_pfizer:
    run: r:latest analysis/merge_seqtrialcox.R pfizer
    needs:
    - match_seqtrialcox_pfizer
    - data_selection
    - data_process_long
    outputs:
      highly_sensitive:
        rds: output/models/seqtrialcox/pfizer/merge_*.rds
      moderately_sensitive:
        txt: output/models/seqtrialcox/pfizer/merge_*.txt
        csv: output/models/seqtrialcox/pfizer/merge_*.csv
        html: output/models/seqtrialcox/pfizer/merge_*.html

  match_seqtrialcox_moderna:
    run: r:latest analysis/match_seqtrialcox.R moderna
    needs:
    - data_selection
    outputs:
      highly_sensitive:
        rds: output/models/seqtrialcox/moderna/match_*.rds
      moderately_sensitive:
        txt: output/models/seqtrialcox/moderna/match_*.txt
        csv: output/models/seqtrialcox/moderna/match_*.csv
        png: output/models/seqtrialcox/moderna/match_*.png
        pdf: output/models/seqtrialcox/moderna/match_*.pdf

  merge_seqtrialcox_moderna:
    run: r:latest analysis/merge_seqtrialcox.R moderna
    needs:
    - match_seqtrialcox_moderna
    - data_selection
    - data_process_long
    outputs:
      highly_sensitive:
        rds: output/models/seqtrialcox/moderna/merge_*.rds
      moderately_sensitive:
        txt: output/models/seqtrialcox/moderna/merge_*.txt
        csv: output/models/seqtrialcox/moderna/merge_*.csv
        html: output/models/seqtrialcox/moderna/merge_*.html

  ## # # # # # # # # # # # # # # # # # # # 
  ## Models 
  ## # # # # # # # # # # # # # # # # # # # 
  ## ###  Positive SARS-CoV-2 Test 

  model_seqtrialcox_pfizer_postest:
    run: r:latest analysis/model_seqtrialcox.R pfizer postest
    needs:
    - match_seqtrialcox_pfizer
    - merge_seqtrialcox_pfizer
    - data_selection
    - data_process_long
    outputs:
      highly_sensitive:
        rds: output/models/seqtrialcox/pfizer/postest/model_*.rds
      moderately_sensitive:
        txt: output/models/seqtrialcox/pfizer/postest/model_*.txt
        csv: output/models/seqtrialcox/pfizer/postest/model_*.csv

  report_seqtrialcox_pfizer_postest:
    run: r:latest analysis/report_seqtrialcox.R pfizer postest
    needs:
    - data_selection
    - model_seqtrialcox_pfizer_postest
    outputs:
      moderately_sensitive:
        csv: output/models/seqtrialcox/pfizer/postest/report_*.csv
        svg: output/models/seqtrialcox/pfizer/postest/report_*.svg
        png: output/models/seqtrialcox/pfizer/postest/report_*.png

  model_seqtrialcox_moderna_postest:
    run: r:latest analysis/model_seqtrialcox.R moderna postest
    needs:
    - match_seqtrialcox_moderna
    - merge_seqtrialcox_moderna
    - data_selection
    - data_process_long
    outputs:
      highly_sensitive:
        rds: output/models/seqtrialcox/moderna/postest/model_*.rds
      moderately_sensitive:
        txt: output/models/seqtrialcox/moderna/postest/model_*.txt
        csv: output/models/seqtrialcox/moderna/postest/model_*.csv

  report_seqtrialcox_moderna_postest:
    run: r:latest analysis/report_seqtrialcox.R moderna postest
    needs:
    - data_selection
    - model_seqtrialcox_moderna_postest
    outputs:
      moderately_sensitive:
        csv: output/models/seqtrialcox/moderna/postest/report_*.csv
        svg: output/models/seqtrialcox/moderna/postest/report_*.svg
        png: output/models/seqtrialcox/moderna/postest/report_*.png

  ## ###  COVID-19 emergency attendance 

  model_seqtrialcox_pfizer_covidemergency:
    run: r:latest analysis/model_seqtrialcox.R pfizer covidemergency
    needs:
    - match_seqtrialcox_pfizer
    - merge_seqtrialcox_pfizer
    - data_selection
    - data_process_long
    outputs:
      highly_sensitive:
        rds: output/models/seqtrialcox/pfizer/covidemergency/model_*.rds
      moderately_sensitive:
        txt: output/models/seqtrialcox/pfizer/covidemergency/model_*.txt
        csv: output/models/seqtrialcox/pfizer/covidemergency/model_*.csv

  report_seqtrialcox_pfizer_covidemergency:
    run: r:latest analysis/report_seqtrialcox.R pfizer covidemergency
    needs:
    - data_selection
    - model_seqtrialcox_pfizer_covidemergency
    outputs:
      moderately_sensitive:
        csv: output/models/seqtrialcox/pfizer/covidemergency/report_*.csv
        svg: output/models/seqtrialcox/pfizer/covidemergency/report_*.svg
        png: output/models/seqtrialcox/pfizer/covidemergency/report_*.png

  model_seqtrialcox_moderna_covidemergency:
    run: r:latest analysis/model_seqtrialcox.R moderna covidemergency
    needs:
    - match_seqtrialcox_moderna
    - merge_seqtrialcox_moderna
    - data_selection
    - data_process_long
    outputs:
      highly_sensitive:
        rds: output/models/seqtrialcox/moderna/covidemergency/model_*.rds
      moderately_sensitive:
        txt: output/models/seqtrialcox/moderna/covidemergency/model_*.txt
        csv: output/models/seqtrialcox/moderna/covidemergency/model_*.csv

  report_seqtrialcox_moderna_covidemergency:
    run: r:latest analysis/report_seqtrialcox.R moderna covidemergency
    needs:
    - data_selection
    - model_seqtrialcox_moderna_covidemergency
    outputs:
      moderately_sensitive:
        csv: output/models/seqtrialcox/moderna/covidemergency/report_*.csv
        svg: output/models/seqtrialcox/moderna/covidemergency/report_*.svg
        png: output/models/seqtrialcox/moderna/covidemergency/report_*.png

  ## ###  COVID-19 unplanned admission 

  model_seqtrialcox_pfizer_covidadmitted:
    run: r:latest analysis/model_seqtrialcox.R pfizer covidadmitted
    needs:
    - match_seqtrialcox_pfizer
    - merge_seqtrialcox_pfizer
    - data_selection
    - data_process_long
    outputs:
      highly_sensitive:
        rds: output/models/seqtrialcox/pfizer/covidadmitted/model_*.rds
      moderately_sensitive:
        txt: output/models/seqtrialcox/pfizer/covidadmitted/model_*.txt
        csv: output/models/seqtrialcox/pfizer/covidadmitted/model_*.csv

  report_seqtrialcox_pfizer_covidadmitted:
    run: r:latest analysis/report_seqtrialcox.R pfizer covidadmitted
    needs:
    - data_selection
    - model_seqtrialcox_pfizer_covidadmitted
    outputs:
      moderately_sensitive:
        csv: output/models/seqtrialcox/pfizer/covidadmitted/report_*.csv
        svg: output/models/seqtrialcox/pfizer/covidadmitted/report_*.svg
        png: output/models/seqtrialcox/pfizer/covidadmitted/report_*.png

  model_seqtrialcox_moderna_covidadmitted:
    run: r:latest analysis/model_seqtrialcox.R moderna covidadmitted
    needs:
    - match_seqtrialcox_moderna
    - merge_seqtrialcox_moderna
    - data_selection
    - data_process_long
    outputs:
      highly_sensitive:
        rds: output/models/seqtrialcox/moderna/covidadmitted/model_*.rds
      moderately_sensitive:
        txt: output/models/seqtrialcox/moderna/covidadmitted/model_*.txt
        csv: output/models/seqtrialcox/moderna/covidadmitted/model_*.csv

  report_seqtrialcox_moderna_covidadmitted:
    run: r:latest analysis/report_seqtrialcox.R moderna covidadmitted
    needs:
    - data_selection
    - model_seqtrialcox_moderna_covidadmitted
    outputs:
      moderately_sensitive:
        csv: output/models/seqtrialcox/moderna/covidadmitted/report_*.csv
        svg: output/models/seqtrialcox/moderna/covidadmitted/report_*.svg
        png: output/models/seqtrialcox/moderna/covidadmitted/report_*.png

  ## ###  COVID-19 ICU/Critical care admission 

  model_seqtrialcox_pfizer_covidcc:
    run: r:latest analysis/model_seqtrialcox.R pfizer covidcc
    needs:
    - match_seqtrialcox_pfizer
    - merge_seqtrialcox_pfizer
    - data_selection
    - data_process_long
    outputs:
      highly_sensitive:
        rds: output/models/seqtrialcox/pfizer/covidcc/model_*.rds
      moderately_sensitive:
        txt: output/models/seqtrialcox/pfizer/covidcc/model_*.txt
        csv: output/models/seqtrialcox/pfizer/covidcc/model_*.csv

  report_seqtrialcox_pfizer_covidcc:
    run: r:latest analysis/report_seqtrialcox.R pfizer covidcc
    needs:
    - data_selection
    - model_seqtrialcox_pfizer_covidcc
    outputs:
      moderately_sensitive:
        csv: output/models/seqtrialcox/pfizer/covidcc/report_*.csv
        svg: output/models/seqtrialcox/pfizer/covidcc/report_*.svg
        png: output/models/seqtrialcox/pfizer/covidcc/report_*.png

  model_seqtrialcox_moderna_covidcc:
    run: r:latest analysis/model_seqtrialcox.R moderna covidcc
    needs:
    - match_seqtrialcox_moderna
    - merge_seqtrialcox_moderna
    - data_selection
    - data_process_long
    outputs:
      highly_sensitive:
        rds: output/models/seqtrialcox/moderna/covidcc/model_*.rds
      moderately_sensitive:
        txt: output/models/seqtrialcox/moderna/covidcc/model_*.txt
        csv: output/models/seqtrialcox/moderna/covidcc/model_*.csv

  report_seqtrialcox_moderna_covidcc:
    run: r:latest analysis/report_seqtrialcox.R moderna covidcc
    needs:
    - data_selection
    - model_seqtrialcox_moderna_covidcc
    outputs:
      moderately_sensitive:
        csv: output/models/seqtrialcox/moderna/covidcc/report_*.csv
        svg: output/models/seqtrialcox/moderna/covidcc/report_*.svg
        png: output/models/seqtrialcox/moderna/covidcc/report_*.png

  ## ###  COVID-19 death 

  model_seqtrialcox_pfizer_coviddeath:
    run: r:latest analysis/model_seqtrialcox.R pfizer coviddeath
    needs:
    - match_seqtrialcox_pfizer
    - merge_seqtrialcox_pfizer
    - data_selection
    - data_process_long
    outputs:
      highly_sensitive:
        rds: output/models/seqtrialcox/pfizer/coviddeath/model_*.rds
      moderately_sensitive:
        txt: output/models/seqtrialcox/pfizer/coviddeath/model_*.txt
        csv: output/models/seqtrialcox/pfizer/coviddeath/model_*.csv

  report_seqtrialcox_pfizer_coviddeath:
    run: r:latest analysis/report_seqtrialcox.R pfizer coviddeath
    needs:
    - data_selection
    - model_seqtrialcox_pfizer_coviddeath
    outputs:
      moderately_sensitive:
        csv: output/models/seqtrialcox/pfizer/coviddeath/report_*.csv
        svg: output/models/seqtrialcox/pfizer/coviddeath/report_*.svg
        png: output/models/seqtrialcox/pfizer/coviddeath/report_*.png

  model_seqtrialcox_moderna_coviddeath:
    run: r:latest analysis/model_seqtrialcox.R moderna coviddeath
    needs:
    - match_seqtrialcox_moderna
    - merge_seqtrialcox_moderna
    - data_selection
    - data_process_long
    outputs:
      highly_sensitive:
        rds: output/models/seqtrialcox/moderna/coviddeath/model_*.rds
      moderately_sensitive:
        txt: output/models/seqtrialcox/moderna/coviddeath/model_*.txt
        csv: output/models/seqtrialcox/moderna/coviddeath/model_*.csv

  report_seqtrialcox_moderna_coviddeath:
    run: r:latest analysis/report_seqtrialcox.R moderna coviddeath
    needs:
    - data_selection
    - model_seqtrialcox_moderna_coviddeath
    outputs:
      moderately_sensitive:
        csv: output/models/seqtrialcox/moderna/coviddeath/report_*.csv
        svg: output/models/seqtrialcox/moderna/coviddeath/report_*.svg
        png: output/models/seqtrialcox/moderna/coviddeath/report_*.png

  combine_seqtrialcox:
    run: r:latest analysis/combine_seqtrialcox.R
    needs:
    - match_seqtrialcox_pfizer
    - merge_seqtrialcox_pfizer
    - match_seqtrialcox_moderna
    - merge_seqtrialcox_moderna
    - model_seqtrialcox_pfizer_postest
    - model_seqtrialcox_pfizer_covidemergency
    - model_seqtrialcox_pfizer_coviddeath
    - model_seqtrialcox_moderna_postest
    - model_seqtrialcox_moderna_covidemergency
    - model_seqtrialcox_moderna_coviddeath
    - report_seqtrialcox_pfizer_postest
    - report_seqtrialcox_pfizer_covidemergency
    - report_seqtrialcox_pfizer_coviddeath
    - report_seqtrialcox_moderna_postest
    - report_seqtrialcox_moderna_covidemergency
    - report_seqtrialcox_moderna_coviddeath
    outputs:
      moderately_sensitive:
        csv: output/models/seqtrialcox/combined/*.csv
        png: output/models/seqtrialcox/combined/*.png
        pdf: output/models/seqtrialcox/combined/*.pdf
        svg: output/models/seqtrialcox/combined/*.svg
        html: output/models/seqtrialcox/combined/*.html

  ## # # # # # # # # # # # # # # # # # # # 
  ## Manuscript 
  ## # # # # # # # # # # # # # # # # # # # 

  manuscript_objects:
    run: r:latest analysis/manuscript_objects.R
    needs:
    - data_selection
    - descriptive_table1
    - descriptive_vaxdate
    - match_seqtrialcox_pfizer
    - match_seqtrialcox_moderna
    - combine_seqtrialcox
    outputs:
      moderately_sensitive:
        csv: output/manuscript-objects/*.csv
        png: output/manuscript-objects/*.png

